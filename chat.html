<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curevia ‚Äì Chat</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --bot: #f1f5f9;
      --user: #e8f0ff;
      --text: #0f172a;
      --muted: #64748b;
      --brand: #0ea5e9;
      --chip: #ffffff;
      --chip-border: #e5e7eb;
      --shadow: 0 6px 24px rgba(15, 23, 42, 0.06);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    .wrap {
      max-width: 840px; margin: 40px auto; padding: 0 16px;
    }

    .chat {
      background: #fff; border-radius: 18px; box-shadow: var(--shadow);
      padding: 16px; display: grid; grid-template-rows: auto 1fr auto auto; gap: 12px;
      min-height: 70vh;
    }

    .messages { overflow-y: auto; padding: 6px 4px; }
    .row { display: flex; margin: 10px 0; }
    .row.user { justify-content: flex-end; }
    .bubble {
      max-width: 75%; padding: 12px 14px; border-radius: var(--radius);
      white-space: pre-wrap; word-wrap: break-word;
    }
    .row.bot .bubble { background: var(--bot); }
    .row.user .bubble { background: var(--user); }

    .chips { display: flex; flex-wrap: wrap; gap: 10px; }
    .chip {
      background: var(--chip); border: 1px solid var(--chip-border);
      padding: 8px 12px; border-radius: 999px; cursor: pointer;
      font-size: 14px;
    }
    .chip:hover { border-color: #cbd5e1; }

    .muted { color: var(--muted); font-size: 13px; }

    form.send {
      display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 6px;
    }
    input[type="text"] {
      border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px 14px; font-size: 16px;
      outline: none; background: #fff;
    }
    button.primary {
      background: var(--brand); color: #fff; border: 0; border-radius: 12px;
      padding: 12px 18px; cursor: pointer; font-weight: 600;
    }
    button.primary:disabled { opacity: .6; cursor: not-allowed; }

    /* Modal */
    .modal {
      position: fixed; inset: 0; display: none; place-items: center; padding: 16px;
      background: rgba(15,23,42,.45); z-index: 50;
    }
    .modal .card {
      width: 100%; max-width: 520px; background: #fff; border-radius: 16px;
      box-shadow: var(--shadow); padding: 18px;
    }
    .modal h3 { margin: 0 0 6px; }
    .grid { display: grid; gap: 10px; }
    .grid.two { grid-template-columns: 1fr 1fr; }
    label { font-size: 14px; color: var(--muted); }
    input[type="email"], input[type="tel"], textarea {
      border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 12px; font-size: 15px;
      outline: none; width: 100%;
    }
    textarea { min-height: 110px; resize: vertical; }
    .card .row-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px; }
    .btn {
      border: 1px solid #e2e8f0; background: #fff; border-radius: 10px; padding: 10px 14px; cursor: pointer;
    }
    .btn.primary { background: var(--brand); color: #fff; border-color: transparent; }
    .status { font-size: 14px; color: var(--muted); margin-top: 6px; min-height: 20px; }
    a { color: #0ea5e9; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="chat">
      <div>
        <div class="muted">Hej! Jag kan hj√§lpa dig med fr√•gor, registrering och kontakthj√§lp. Skriv h√§r üëá</div>
      </div>

      <div id="messages" class="messages"></div>

      <!-- chips -->
      <div id="chips" class="chips">
        <button class="chip" data-q="Registrera konsult">Registrera konsult</button>
        <button class="chip" data-q="Registrera v√•rdgivare">Registrera v√•rdgivare</button>
        <button class="chip" data-q="V√•rdgivare ‚Äì pris">V√•rdgivare ‚Äì pris</button>
        <button class="chip" data-q="Onboarding">Onboarding</button>
        <button class="chip" data-q="Eget bolag?">Eget bolag?</button>
        <button class="chip" data-q="Utbetalningar">Utbetalningar</button>
        <button class="chip" id="chip-contact">Kontakta mig</button>
        <button class="chip" data-q="Jag vill boka en demo">Boka demo</button>
      </div>

      <!-- input -->
      <form id="send" class="send" autocomplete="off">
        <input id="input" type="text" placeholder="Skriv din fr√•ga‚Ä¶" />
        <button id="sendBtn" class="primary" type="submit">Skicka</button>
      </form>

      <div class="muted">‚ö†Ô∏è Skriv inte in personnummer eller journaluppgifter.</div>
    </div>
  </div>

  <!-- Kontakt-modal -->
  <div id="contact-modal" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <h3>Kontakta mig</h3>
      <div class="muted">Fyll i dina uppgifter s√• h√∂r vi av oss inom kort.</div>
      <div class="grid two" style="margin-top:10px;">
        <div>
          <label for="contact-name">Namn</label>
          <input id="contact-name" type="text" placeholder="F√∂r- och efternamn" />
        </div>
        <div>
          <label for="contact-email">E-post</label>
          <input id="contact-email" type="email" placeholder="namn@example.com" />
        </div>
      </div>
      <div class="grid" style="margin-top:10px;">
        <div class="two" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <label for="contact-phone">Telefon (valfritt)</label>
            <input id="contact-phone" type="tel" placeholder="070‚Ä¶" />
          </div>
          <div></div>
        </div>
        <div>
          <label for="contact-message">Meddelande (valfritt)</label>
          <textarea id="contact-message" placeholder="Kort beskrivning‚Ä¶"></textarea>
        </div>
      </div>
      <div class="row-actions">
        <button class="btn" id="contact-cancel">Avbryt</button>
        <button class="btn primary" id="contact-send">Skicka</button>
      </div>
      <div id="contact-status" class="status"></div>
    </div>
  </div>

  <script>
    // ---- ENDPOINTS ----
    const GPT_ENDPOINT = "/api/curevia-chat";
    const CONTACT_ENDPOINT = "/api/contact";

    // ---- UI helpers ----
    const $ = sel => document.querySelector(sel);
    const messages = $("#messages");
    const input = $("#input");
    const form = $("#send");
    const sendBtn = $("#sendBtn");

    function addBubble(role, text, allowHTML = false) {
      const row = document.createElement("div");
      row.className = "row " + (role === "user" ? "user" : "bot");
      const b = document.createElement("div");
      b.className = "bubble";
      if (allowHTML) b.innerHTML = text; else b.textContent = text;
      row.appendChild(b);
      messages.appendChild(row);
      messages.scrollTop = messages.scrollHeight;
    }

    // ---- Kontakt-intent ----
    const CONTACT_PATTERNS = [
      /kontakt(?:a|as)?\s*mig/i,
      /vill (?:bli|ha) kontakt/i,
      /h√∂r av er/i,
      /ring (?:mig|upp)/i,
      /mejla (?:mig|m ig)/i,
      /kan ni kontakta/i,
      /skulle g√§rna vilja komma i kontakt/i
    ];
    function wantsContact(t=""){ return CONTACT_PATTERNS.some(re => re.test(t)); }

    function guessNameFromText(t=""){
      const m = t.match(/\b([A-Z√Ö√Ñ√ñ][a-√∂√•√§√∂]+)\s+([A-Z√Ö√Ñ√ñ][a-√∂√•√§√∂]+)\b/);
      return m ? `${m[1]} ${m[2]}` : "";
    }

    function openContactModal(prefillMsg = "", guessFrom = "") {
      const modal = $("#contact-modal");
      if (!modal) return;
      const msg = $("#contact-message");
      if (msg && prefillMsg) msg.value = prefillMsg.slice(0, 500);
      const g = guessNameFromText(guessFrom);
      if (g && $("#contact-name")) $("#contact-name").value = g;
      modal.style.display = "grid";
    }
    function closeContactModal() { $("#contact-modal").style.display = "none"; }

    // ---- Kontakt-modal hooks ----
    $("#contact-cancel")?.addEventListener("click", (e)=>{ e.preventDefault(); closeContactModal(); });

    $("#contact-send")?.addEventListener("click", async (e)=>{
      e.preventDefault();
      const name = $("#contact-name").value.trim();
      const email = $("#contact-email").value.trim();
      const phone = $("#contact-phone").value.trim();
      const message = $("#contact-message").value.trim();
      const status = $("#contact-status");
      if (!name || !email) {
        status.textContent = "Ange namn och e-post, tack.";
        return;
      }
      status.textContent = "Skickar‚Ä¶";
      try {
        const r = await fetch(CONTACT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, phone, message })
        });
        const data = await r.json();
        if (data.ok) {
          status.textContent = "Tack! Vi h√∂r av oss inom kort.";
          setTimeout(closeContactModal, 1200);
          addBubble("bot", "Toppen, tack! Vi √•terkommer snart. üôå");
        } else {
          status.textContent = "Kunde inte skicka just nu. Prova igen eller mejla oss.";
          console.error("contact error:", data);
        }
      } catch (err) {
        status.textContent = "Tekniskt fel. Prova igen senare.";
        console.error(err);
      }
    });

    // ---- Chips ----
    document.querySelectorAll(".chip[data-q]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const q = btn.getAttribute("data-q");
        input.value = q;
        form.requestSubmit();
      });
    });
    $("#chip-contact")?.addEventListener("click", ()=>{
      addBubble("bot", "Toppen! Fyll i dina uppgifter s√• h√∂r vi av oss inom kort. üôå");
      openContactModal("", "");
    });

    // ---- Form submit (huvudlogik) ----
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const userText = (input.value || "").trim();
      if (!userText) return;

      // 1) om kontakt ‚Üí √∂ppna formul√§r & hoppa √∂ver GPT
      if (wantsContact(userText)) {
        addBubble("user", userText);
        addBubble("bot", "Sj√§lvklart! Fyll i dina kontaktuppgifter s√• h√∂r vi av oss inom kort. üôå");
        openContactModal(`Anv√§ndaren skrev: "${userText}"`, userText);
        input.value = "";
        return;
      }

      // 2) annars GPT
      addBubble("user", userText);
      input.value = "";
      sendBtn.disabled = true;
      try {
        const r = await fetch(GPT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userText })
        });
        const data = await r.json();
        const reply = data?.reply || "Vill du boka en demo s√• visar jag mer?";
        // till√•t enkla l√§nkar
        addBubble("bot", reply, true);
      } catch (err) {
        addBubble("bot", "Tekniskt fel just nu ‚Äì f√∂rs√∂k g√§rna igen om en stund.");
        console.error(err);
      } finally {
        sendBtn.disabled = false;
      }
    });

    // ---- F√∂rsta h√§lsning ----
    addBubble("bot", "Hej! ‚ú® Vad vill du g√∂ra ‚Äì f√• svar p√• en fr√•ga, registrera dig eller bli kontaktad?");
  </script>
</body>
</html>
