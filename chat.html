<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Curevia – Chatt</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#ffffff; --fg:#0f1115; --muted:#6b7280; --line:#e5e7eb; --card:#f8fafc;
      --brand:#111; --brand-fg:#fff; --bubble-me:#e8f0ff; --bubble-bot:#f5f7fb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--fg);
    }
    .wrap{max-width:820px; height:100%; margin:0 auto; display:flex; flex-direction:column}
    header{
      display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--line);
      position:sticky; top:0; background:var(--bg); z-index:2;
    }
    header .logo{
      width:32px; height:32px; border-radius:8px; background:#111; color:#fff; display:grid; place-items:center; font-weight:700;
    }
    header h1{font-size:16px; margin:0}
    .chat{flex:1; min-height:0; padding:16px; overflow:auto; background:var(--bg)}
    .row{display:flex; margin:8px 0}
    .msg{
      max-width:80%; padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background:var(--bubble-bot); white-space:pre-wrap; word-wrap:break-word;
    }
    .me{justify-content:flex-end}
    .me .msg{background:var(--bubble-me)}
    .bot .msg{background:var(--bubble-bot)}
    .typing{display:inline-block; min-width:36px}
    .dot{width:6px; height:6px; margin:0 2px; background:#c1c7d0; border-radius:50%; display:inline-block; animation:b 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s} .dot:nth-child(3){animation-delay:.3s}
    @keyframes b{0%,80%,100%{opacity:.3} 40%{opacity:1}}
    .notice{padding:10px 16px; border-top:1px solid var(--line); color:var(--muted); font-size:12px}
    .quick{display:flex; gap:8px; flex-wrap:wrap; padding:8px 16px}
    .chip{padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:#fafafa; cursor:pointer}
    form{display:flex; gap:8px; padding:12px; border-top:1px solid var(--line); background:var(--bg)}
    input[type=text]{flex:1; padding:12px; border:1px solid var(--line); border-radius:12px}
    button.send{padding:12px 14px; border-radius:12px; border:none; background:var(--brand); color:var(--brand-fg); cursor:pointer}
    .actions{display:flex; gap:8px; padding:0 16px 8px}
    .btn{padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer}
    .btn.brand{background:var(--brand); color:var(--brand-fg); border-color:var(--brand)}
    a{color:inherit}
    .muted{color:var(--muted)}
    @media (max-width:560px){ .msg{max-width:90%} }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Curevia chatt">
    <header>
      <div class="logo">CV</div>
      <h1>Curevia – chatt</h1>
    </header>

    <div id="thread" class="chat" aria-live="polite"></div>

    <div class="actions">
      <button class="btn" data-link="https://curevia.ai/consultant/register">Registrera konsult</button>
      <button class="btn" data-link="https://curevia.ai/auth?type=signup&returnTo=/employer/register">Registrera vårdgivare</button>
      <button class="btn brand" data-link="https://calendly.com/tim-curevia/30min">Boka demo</button>
    </div>

    <div class="quick" aria-label="Snabbval">
      <button class="chip" data-prompt="Jag är vårdgivare. Vad kostar tjänsten?">Vårdgivare – pris</button>
      <button class="chip" data-prompt="Hur fungerar onboarding?">Onboarding</button>
      <button class="chip" data-prompt="Behöver jag eget bolag?">Eget bolag?</button>
      <button class="chip" data-prompt="Hur fungerar utbetalningar?">Utbetalningar</button>
    </div>

    <div class="notice">⚠️ Skriv inte in personnummer eller journaluppgifter.</div>

    <form id="form" autocomplete="off" aria-label="Skicka meddelande">
      <input id="input" type="text" placeholder="Skriv din fråga…" />
      <button class="send" type="submit">Skicka</button>
    </form>
  </div>

  <script>
    // === KONFIG ===
    const ENDPOINT = "/api/curevia-chat"; // samma origin i Vercel
    const LINKS = {
      regConsult: "https://curevia.ai/consultant/register",
      regProvider: "https://curevia.ai/auth?type=signup&returnTo=/employer/register",
      demo: "https://calendly.com/tim-curevia/30min"
    };

    // === DOM ===
    const thread = document.getElementById("thread");
    const form   = document.getElementById("form");
    const input  = document.getElementById("input");

    // === Hjälp ===
    const linkify = (t) =>
      t.replace(/(https?:\/\/[^\s)]+)/g, (m) => `<a href="${m}" target="_blank" rel="noopener">${m}</a>`);

    function add(text, me=false){
      const row = document.createElement("div");
      row.className = "row " + (me ? "me" : "bot");
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.innerHTML = linkify(text);
      row.appendChild(bubble);
      thread.appendChild(row);
      thread.scrollTop = thread.scrollHeight;
      saveHistory();
    }

    function addTyping(){
      const row = document.createElement("div");
      row.className = "row bot typing-row";
      const bubble = document.createElement("div");
      bubble.className = "msg typing";
      bubble.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      row.appendChild(bubble);
      thread.appendChild(row);
      thread.scrollTop = thread.scrollHeight;
    }
    function removeTyping(){
      const el = document.querySelector(".typing-row");
      if (el) el.remove();
    }

    // === Historik (enkel) ===
    const KEY="cv_chat_history_v1";
    function saveHistory(){
      const rows=[...thread.querySelectorAll(".row")].map(r=>({
        me: r.classList.contains("me"),
        html: r.querySelector(".msg").innerHTML
      }));
      localStorage.setItem(KEY, JSON.stringify(rows).slice(0, 40_000));
    }
    function loadHistory(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return;
        const rows = JSON.parse(raw);
        rows.forEach(r=>{
          const row=document.createElement("div"); row.className="row "+(r.me?"me":"bot");
          const b=document.createElement("div"); b.className="msg"; b.innerHTML=r.html;
          row.appendChild(b); thread.appendChild(row);
        });
      }catch{}
    }

    // === App ===
    async function ask(q){
      const trimmed = q.trim();
      if (!trimmed) return;
      add(trimmed, true);
      input.value = ""; input.focus();

      // blockera uppenbart personnummer lokalt också
      const pnr = /\b(\d{6}|\d{8})[-+]?\d{4}\b/;
      if (pnr.test(trimmed)){
        add("Jag kan tyvärr inte ta emot person- eller journaluppgifter här. Kontakta oss via säker kanal.", false);
        return;
      }

      addTyping();
      try{
        const r = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: trimmed })
        });
        const data = await r.json();
        removeTyping();

        if (data?.reply){
          add(data.reply, false);
        } else if (data?.error){
          console.warn("API error:", data.error);
          add("Tekniskt fel just nu. Testa igen senare eller boka en demo: "+LINKS.demo, false);
        } else {
          add("Vill du boka en demo så visar jag mer? "+LINKS.demo, false);
        }
      }catch(e){
        removeTyping();
        console.error(e);
        add("Kunde inte nå servern. Kontrollera uppkopplingen eller prova igen.", false);
      }
    }

    form.addEventListener("submit", (e)=>{ e.preventDefault(); ask(input.value); });
    document.querySelectorAll(".chip").forEach(b=> b.addEventListener("click", ()=> ask(b.dataset.prompt)));
    document.querySelectorAll(".btn").forEach(b=> b.addEventListener("click", ()=> window.open(b.dataset.link, "_blank")));

    // Första meddelande
    function welcome(){
      add("Hej! Jag kan hjälpa dig med frågor, registrering och demobokning. Vad vill du göra?");
    }

    // Init
    loadHistory();
    if (thread.children.length === 0) welcome();
  </script>
</body>
</html>
