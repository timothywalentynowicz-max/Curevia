<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curevia ‚Äì Chat</title>
  <meta name="color-scheme" content="light">
  <style>
    :root{
      --bg:#f6f7fb; --bot:#f1f5f9; --user:#2563eb; --text:#0f172a; --muted:#64748b;
      --shadow:0 6px 24px rgba(15,23,42,.06); --radius:18px;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);margin:0;color:var(--text)}
    .shell{max-width:820px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;gap:12px;margin:0 0 10px}
    .logo{width:36px;height:36px;border-radius:10px;background:#0ea5e9}
    .title{font-weight:700}
    .subtitle{font-size:12px;color:var(--muted)}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .chips{display:flex;gap:8px;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid #e2e8f0;background:#f8fafc}
    .chip{background:#e2e8f0;border:1px solid #cbd5e1;border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer}
    .log{height:58vh;overflow:auto;padding:16px}
    .bubble{padding:12px 14px;border-radius:var(--radius);margin:8px 0;max-width:80%;line-height:1.35;white-space:pre-wrap;word-wrap:break-word}
    .bot{background:var(--bot);border-top-left-radius:8px}
    .me{background:var(--user);color:#fff;margin-left:auto;border-top-right-radius:8px}
    .cite{display:block;font-size:11px;margin-top:6px;opacity:.75}
    .row{display:flex;gap:10px;padding:12px;border-top:1px solid #e2e8f0;background:#fff}
    .in{flex:1;padding:12px 14px;border:1px solid #cbd5e1;border-radius:14px}
    .btn{padding:12px 16px;border:0;border-radius:14px;background:#0f172a;color:#fff}
    .foot{font-size:12px;color:var(--muted);padding:8px 16px;background:#fff;border-top:1px solid #e2e8f0}
    @media (max-width:640px){ .log{height:60vh} }

    /* Typing animation (fallback medan vi v√§ntar p√• f√∂rsta token) */
    .typing-wrap{display:inline-flex;gap:6px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#94a3b8;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{
      0%,100%{opacity:.25; transform:translateY(0)}
      20%    {opacity:1;    transform:translateY(-2px)}
    }

    /* Modal */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,.4);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{background:#fff;border-radius:16px;box-shadow:var(--shadow);max-width:520px;width:100%}
    .modal .head{padding:14px 16px;border-bottom:1px solid #e2e8f0;font-weight:600}
    .modal .body{padding:16px}
    .modal .row{display:flex;gap:8px;padding:0;border:0;background:none}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field input,.field textarea{padding:10px;border:1px solid #cbd5e1;border-radius:12px;width:100%}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;padding:14px 16px;border-top:1px solid #e2e8f0}
    .link{color:#2563eb;text-decoration:underline}
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="logo"></div>
      <div>
        <div class="title">Curevia Assistant</div>
        <div class="subtitle">Snabb hj√§lp ‚Ä¢ Demo n√§r du vill</div>
      </div>
    </div>

    <div class="card">
      <div id="chips" class="chips"></div>

      <div id="log" class="log"></div>

      <div class="row">
        <input id="inp" class="in" placeholder="St√§ll en fr√•ga‚Ä¶" />
        <button id="btn" class="btn">Skicka</button>
      </div>

      <div class="foot" id="footnote" style="display:none">
        Botten anv√§nder Curevias k√§llor f√∂r att svara korrekt.
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div id="backdrop" class="modal-back" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="head">L√§mna dina uppgifter</div>
      <div class="body">
        <div class="field">
          <label for="name">Namn</label>
          <input id="name" placeholder="F√∂r- och efternamn" />
        </div>
        <div class="field">
          <label for="email">E-post</label>
          <input id="email" placeholder="namn@exempel.se" />
        </div>
        <div class="field">
          <label for="msg">Meddelande (valfritt)</label>
          <textarea id="msg" rows="3" placeholder="Kort rad om vad du vill prata om"></textarea>
        </div>
      </div>
      <div class="actions">
        <button id="cancel" class="btn" style="background:#e2e8f0;color:#0f172a">Avbryt</button>
        <button id="send" class="btn">Skicka</button>
      </div>
    </div>
  </div>

<script>
const API = "/api/curevia-chat";
const log = document.getElementById("log");
const chipsEl = document.getElementById("chips");
const inp = document.getElementById("inp");
const btn = document.getElementById("btn");
const footnote = document.getElementById("footnote");
const sessionId = self.crypto?.randomUUID?.() || ("sess-" + Date.now());

// Modal refs
const backdrop = document.getElementById("backdrop");
const fName = document.getElementById("name");
const fEmail = document.getElementById("email");
const fMsg = document.getElementById("msg");
document.getElementById("cancel").onclick = ()=> toggleModal(false);
document.getElementById("send").onclick = submitContact;

function toggleModal(open){ backdrop.style.display = open ? "flex" : "none"; }

function addBubble(text, who="bot", citations){
  const div = document.createElement("div");
  div.className = "bubble " + (who==="me"?"me":"bot");
  div.textContent = text;
  if (citations && citations.length){
    citations.forEach(c=>{
      const a = document.createElement("a");
      a.href = c.url; a.target="_blank"; a.rel="noreferrer"; a.className="cite link";
      a.textContent = `[${c.id}] ${c.title}`;
      div.appendChild(a);
    });
    footnote.style.display = "block";
  }
  log.appendChild(div);
  log.scrollTo({ top: log.scrollHeight, behavior: "smooth" });
  return div;
}

/* --- Skrivanimering (fallback innan f√∂rsta token kommer) --- */
function typingBubble(){
  const div = document.createElement("div");
  div.className = "bubble bot";
  const wrap = document.createElement("div");
  wrap.className = "typing-wrap";
  wrap.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  div.appendChild(wrap);
  log.appendChild(div);
  log.scrollTo({ top: log.scrollHeight, behavior: "smooth" });
  return { destroy(){ div.remove(); } };
}

async function meta(){
  try{
    const r = await fetch(API, { headers: { "X-Session-Id": sessionId }});
    const m = await r.json();
    addBubble("Hej! üëã Jag √§r Curevia-boten ‚Äì hur kan jag hj√§lpa till idag?");
    (m.suggested||[]).forEach(c => {
      const el = document.createElement("span");
      el.className = "chip";
      el.textContent = c.label;
      el.onclick = () => send(c.label);
      chipsEl.appendChild(el);
    });
  }catch{
    addBubble("Jag n√•dde inte servern just nu ‚Äì prova igen om en stund üôè");
  }
}

/* --------- STREAMANDE SVAR (SSE via fetch stream) ---------- */
async function send(text){
  if (!text?.trim()) return;
  addBubble(text, "me");
  inp.value = "";

  // F√∂rbered en bot-bubbla som vi fyller p√• med tokens
  const bubble = addBubble("", "bot");
  let receivedAny = false;
  let citationsMeta = [];

  // Starta en tempor√§r skriv-animering tills f√∂rsta token landar
  const typing = typingBubble();

  try{
    const r = await fetch(API + "?stream=1", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "X-Session-Id": sessionId,
        "Accept":"text/event-stream"
      },
      body: JSON.stringify({ message: text })
    });

    if (!r.body) throw new Error("No stream");

    const reader = r.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buf = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream:true });

      // Parsar SSE (event: <name>\n data: <json>\n\n)
      let idx;
      while ((idx = buf.indexOf("\n\n")) >= 0) {
        const raw = buf.slice(0, idx);
        buf = buf.slice(idx + 2);

        const lines = raw.split(/\r?\n/);
        let event = "message", data = "";
        for (const line of lines) {
          if (line.startsWith("event:")) event = line.slice(6).trim();
          else if (line.startsWith("data:")) data += line.slice(5).trim();
        }

        if (!data) continue;

        if (event === "meta") {
          // { model, schema, citations? }
          try { const m = JSON.parse(data); citationsMeta = m.citations || []; } catch {}
        }
        else if (event === "token") {
          typing.destroy(); // f√∂rsta token ‚Üí ta bort "...‚Äù
          receivedAny = true;
          bubble.textContent += data;                // L√§gg till token
          log.scrollTo({ top: log.scrollHeight });   // H√•ll scroll i botten
        }
        else if (event === "action") {
          // { action: "open_url", url }
          try {
            const a = JSON.parse(data);
            if (a.action === "open_url" && a.url) window.open(a.url, "_blank", "noopener,noreferrer");
            if (a.action === "open_contact_form") toggleModal(true);
          } catch {}
        }
        else if (event === "final") {
          typing.destroy();
          // final kan vara str√§ng eller objekt; v√•r backend skickar ett objekt
          try {
            const f = JSON.parse(data);
            if (!receivedAny && f.reply) bubble.textContent = f.reply; // om vi inte streamat n√•got
            // citations
            const cites = f.citations || citationsMeta || [];
            if (cites && cites.length) {
              cites.forEach(c=>{
                const a = document.createElement("a");
                a.href = c.url; a.target="_blank"; a.rel="noreferrer"; a.className="cite link";
                a.textContent = `[${c.id}] ${c.title}`;
                bubble.appendChild(a);
              });
              footnote.style.display = "block";
            }
          } catch { /* om final var bara text, ignorera */ }
        }
        else if (event === "error") {
          typing.destroy();
          addBubble("Tekniskt fel ‚Äì prova igen.", "bot");
        }
      }
    }

  }catch(err){
    typing.destroy();
    bubble.textContent = "Tekniskt fel ‚Äì prova igen.";
  }
}

async function submitContact(){
  const name = fName.value.trim();
  const email = fEmail.value.trim();
  const message = fMsg.value.trim();
  if (!name || !email) { alert("Fyll i namn och e-post"); return; }
  try{
    const r = await fetch(API, {
      method: "POST",
      headers: { "Content-Type":"application/json", "X-Session-Id": sessionId },
      body: JSON.stringify({ contact: { name, email, message} })
    });
    if (r.ok){
      toggleModal(false);
      addBubble("Tack! Vi h√∂r av oss inom kort üíô");
      fName.value = ""; fEmail.value = ""; fMsg.value = "";
    } else {
      addBubble("Kunde inte skicka just nu ‚Äì maila oss g√§rna s√• l√∂ser vi det.", "bot");
    }
  }catch{
    addBubble("Kunde inte skicka just nu ‚Äì prova igen senare.", "bot");
  }
}

btn.onclick = () => send(inp.value);
inp.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(inp.value); });

meta();
</script>
</body>
</html>
