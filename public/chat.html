<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curevia ‚Äì Chat</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --bot:#f1f5f9; --user:#2563eb; --text:#0f172a; --muted:#64748b;
      --border:#e2e8f0; --chip:#e2e8f0; --chip-b:#cbd5e1; --btn:#0f172a; --shadow:0 6px 24px rgba(15,23,42,.06);
      --radius:18px;
    }
    .dark{
      --bg:#0b1220; --card:#0f172a; --bot:#0b1a33; --user:#3b82f6; --text:#e5e7eb; --muted:#94a3b8;
      --border:#1f2a44; --chip:#12203a; --chip-b:#213050; --btn:#111827; --shadow:0 6px 24px rgba(2,6,23,.4);
    }

    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);margin:0;color:var(--text)}
    .shell{max-width:820px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:#0ea5e9}
    .title{font-weight:700}
    .subtitle{font-size:12px;color:var(--muted)}
    .toggle{border:1px solid var(--border); background:var(--card); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer}

    .card{background:var(--card);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .chips{display:flex;gap:8px;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid var(--border);background:color-mix(in srgb, var(--card) 80%, var(--bg))}
    .chip{background:var(--chip);border:1px solid var(--chip-b);border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer}
    .log{height:58vh;overflow:auto;padding:16px}
    .bubble{position:relative;padding:12px 40px 12px 14px;border-radius:var(--radius);margin:8px 0;max-width:80%;line-height:1.35;white-space:pre-wrap;word-wrap:break-word}
    .bot{background:var(--bot);border-top-left-radius:8px}
    .me{background:var(--user);color:#fff;margin-left:auto;border-top-right-radius:8px}
    .cite{display:block;font-size:11px;margin-top:6px;opacity:.75}
    .row{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border);background:var(--card)}
    .in{flex:1;padding:12px 14px;border:1px solid var(--chip-b);background:transparent;color:var(--text);border-radius:14px}
    .btn{padding:12px 16px;border:0;border-radius:14px;background:var(--btn);color:#fff;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:default}
    .foot{font-size:12px;color:var(--muted);padding:8px 16px;background:var(--card);border-top:1px solid var(--border)}
    @media (max-width:640px){ .log{height:60vh} }

    /* Typing animation */
    .typing-wrap{display:inline-flex;gap:6px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#94a3b8;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{ 0%,100%{opacity:.25;transform:translateY(0)} 20%{opacity:1;transform:translateY(-2px)} }

    /* Copy button (visas bara p√• l√•nga bot-svar) */
    .copy{
      position:absolute; right:8px; top:8px;
      border:1px solid var(--chip-b); background:transparent; color:var(--muted);
      border-radius:10px; padding:4px 8px; font-size:12px; cursor:pointer;
    }
    .copy.ok{ color:#16a34a; border-color:#16a34a }
    .copy.err{ color:#ef4444; border-color:#ef4444 }

    /* Modal */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,.4);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{background:var(--card);color:var(--text);border-radius:16px;box-shadow:var(--shadow);max-width:520px;width:100%;border:1px solid var(--border)}
    .modal .head{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
    .modal .body{padding:16px}
    .modal .row{display:flex;gap:8px;padding:0;border:0;background:none}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field input,.field textarea{padding:10px;border:1px solid var(--chip-b);border-radius:12px;width:100%;background:transparent;color:var(--text)}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;padding:14px 16px;border-top:1px solid var(--border)}
    .link{color:#3b82f6;text-decoration:underline}
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title" id="ui-title">Curevia Assistant</div>
          <div class="subtitle" id="ui-subtitle">Snabb hj√§lp ‚Ä¢ Demo n√§r du vill</div>
        </div>
      </div>
      <button id="theme" class="toggle" type="button">üåó M√∂rkt l√§ge</button>
    </div>

    <div class="card">
      <div id="chips" class="chips"></div>
      <div id="log" class="log"></div>
      <div class="row">
        <input id="inp" class="in" placeholder="St√§ll en fr√•ga‚Ä¶" />
        <button id="btn" class="btn" type="button">Skicka</button>
      </div>
      <div class="foot" id="footnote" style="display:none">
        Botten anv√§nder Curevias k√§llor f√∂r att svara korrekt.
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div id="backdrop" class="modal-back" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="head" id="ui-modal-title">L√§mna dina uppgifter</div>
      <div class="body">
        <div class="field">
          <label for="name" id="ui-name-label">Namn</label>
          <input id="name" placeholder="F√∂r- och efternamn" />
        </div>
        <div class="field">
          <label for="email" id="ui-email-label">E-post</label>
          <input id="email" placeholder="namn@exempel.se" />
        </div>
        <div class="field">
          <label for="msg" id="ui-msg-label">Meddelande (valfritt)</label>
          <textarea id="msg" rows="3" placeholder="Kort rad om vad du vill prata om"></textarea>
        </div>
      </div>
      <div class="actions">
        <button id="cancel" class="btn" type="button" style="background:var(--chip);color:var(--text)">Avbryt</button>
        <button id="send" class="btn" type="button">Skicka</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ---- Language detection (sv / no / en)
  function detectLang(){
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
    const nlang = (navigator.languages && navigator.languages[0]) || navigator.language || "";
    const low = (nlang || "").toLowerCase();
    if (tz.includes("Stockholm") || low.startsWith("sv")) return "sv";
    if (tz.includes("Oslo") || low.startsWith("no") || low.startsWith("nb") || low.startsWith("nn")) return "no";
    return "en";
  }
  const LANG = detectLang();
  const I18N = {
    sv:{title:"Curevia Assistant",subtitle:"Snabb hj√§lp ‚Ä¢ Demo n√§r du vill",placeholder:"St√§ll en fr√•ga‚Ä¶",send:"Skicka",dark_on:"üåó M√∂rkt l√§ge",dark_off:"‚òÄÔ∏è Ljust l√§ge",hello:"Hej! üëã Jag √§r Curevia-boten ‚Äì hur kan jag hj√§lpa till idag?",foot:"Botten anv√§nder Curevias k√§llor f√∂r att svara korrekt.",modal_title:"L√§mna dina uppgifter",name:"Namn",email:"E-post",msg:"Meddelande (valfritt)",cancel:"Avbryt",submit:"Skicka",error_server:"Jag n√•dde inte servern just nu ‚Äì prova igen om en stund üôè",error_tech:"Tekniskt fel ‚Äì prova igen.",copied:"Kopierat ‚úì",copy:"Kopiera",fail:"Fel"},
    no:{title:"Curevia-assistenten",subtitle:"Rask hjelp ‚Ä¢ Demo n√•r du vil",placeholder:"Still et sp√∏rsm√•l‚Ä¶",send:"Send",dark_on:"üåó M√∏rk modus",dark_off:"‚òÄÔ∏è Lys modus",hello:"Hei! üëã Jeg er Curevia-boten ‚Äì hvordan kan jeg hjelpe deg i dag?",foot:"Botten bruker Curevias kilder for √• svare korrekt.",modal_title:"Legg igjen kontaktinfo",name:"Navn",email:"E-post",msg:"Melding (valgfritt)",cancel:"Avbryt",submit:"Send",error_server:"Jeg fikk ikke kontakt med serveren ‚Äì pr√∏v igjen senere üôè",error_tech:"Teknisk feil ‚Äì pr√∏v igjen.",copied:"Kopiert ‚úì",copy:"Kopier",fail:"Feil"},
    en:{title:"Curevia Assistant",subtitle:"Quick help ‚Ä¢ Demo anytime",placeholder:"Ask a question‚Ä¶",send:"Send",dark_on:"üåó Dark mode",dark_off:"‚òÄÔ∏è Light mode",hello:"Hi! üëã I‚Äôm the Curevia assistant ‚Äî how can I help today?",foot:"The assistant uses Curevia sources for accurate answers.",modal_title:"Leave your details",name:"Name",email:"Email",msg:"Message (optional)",cancel:"Cancel",submit:"Send",error_server:"I couldn‚Äôt reach the server ‚Äî please try again üôè",error_tech:"Technical error ‚Äî please try again.",copied:"Copied ‚úì",copy:"Copy",fail:"Error"}
  }[LANG];

  document.documentElement.lang = LANG;
  const $ = (id)=>document.getElementById(id);
  $("ui-title").textContent = I18N.title;
  $("ui-subtitle").textContent = I18N.subtitle;
  $("inp").placeholder = I18N.placeholder;
  $("btn").textContent = I18N.send;
  $("footnote").textContent = I18N.foot;
  $("ui-modal-title").textContent = I18N.modal_title;
  $("ui-name-label").textContent = I18N.name;
  $("ui-email-label").textContent = I18N.email;
  $("ui-msg-label").textContent = I18N.msg;

  // Theme
  const themeBtn = $("theme");
  const savedTheme = localStorage.getItem("cv_theme");
  if (savedTheme === "dark") document.documentElement.classList.add("dark");
  themeBtn.textContent = document.documentElement.classList.contains("dark") ? I18N.dark_off : I18N.dark_on;
  themeBtn.addEventListener("click", () => {
    document.documentElement.classList.toggle("dark");
    const isDark = document.documentElement.classList.contains("dark");
    localStorage.setItem("cv_theme", isDark ? "dark" : "light");
    themeBtn.textContent = isDark ? I18N.dark_off : I18N.dark_on;
  });

  // DOM refs
  const API = "/api/curevia-chat";
  const log = $("log"), chipsEl = $("chips"), inp = $("inp"), btn = $("btn"), footnote = $("footnote");
  const sessionId = self.crypto?.randomUUID?.() || ("sess-" + Date.now());

  // Modal
  const backdrop = $("backdrop"), fName=$("name"), fEmail=$("email"), fMsg=$("msg");
  $("cancel").onclick = ()=> toggleModal(false);
  $("send").textContent = I18N.submit; $("cancel").textContent = I18N.cancel; $("send").onclick = submitContact;
  function toggleModal(open){ backdrop.style.display = open ? "flex" : "none"; }

  function attachCopyButton(div){
    const cbtn = document.createElement("button");
    cbtn.className = "copy"; cbtn.type="button"; cbtn.textContent = I18N.copy; cbtn.title = I18N.copy;
    cbtn.onclick = async (e)=>{
      e.stopPropagation();
      try{
        const text = div.childNodes[0]?.nodeValue || div.innerText;
        await navigator.clipboard.writeText(text.trim());
        cbtn.classList.remove("err"); cbtn.classList.add("ok"); cbtn.textContent = I18N.copied;
        setTimeout(()=>{ cbtn.classList.remove("ok"); cbtn.textContent = I18N.copy; }, 1500);
      }catch{
        cbtn.classList.remove("ok"); cbtn.classList.add("err"); cbtn.textContent = I18N.fail;
        setTimeout(()=>{ cbtn.classList.remove("err"); cbtn.textContent = I18N.copy; }, 1500);
      }
    };
    div.appendChild(cbtn);
  }

  function addBubble(text, who="bot", citations){
    const div = document.createElement("div");
    div.className = "bubble " + (who==="me"?"me":"bot");
    div.textContent = text;
    // Visa ‚ÄúKopiera‚Äù bara p√• l√•nga bot-svar
    if (who !== "me" && text && text.length >= 120) attachCopyButton(div);
    if (citations && citations.length){
      citations.forEach(c=>{
        const a = document.createElement("a");
        a.href = c.url; a.target="_blank"; a.rel="noreferrer"; a.className="cite link";
        a.textContent = `[${c.id}] ${c.title}`;
        div.appendChild(a);
      });
      footnote.style.display = "block";
    }
    log.appendChild(div);
    log.scrollTo({ top: log.scrollHeight, behavior: "smooth" });
    return div;
  }

  function typingBubble(){
    const div = document.createElement("div");
    div.className = "bubble bot";
    const wrap = document.createElement("div");
    wrap.className = "typing-wrap";
    wrap.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    div.appendChild(wrap);
    log.appendChild(div);
    log.scrollTo({ top: log.scrollHeight, behavior: "smooth" });
    let timer = setTimeout(()=>{ div.remove(); }, 30000);
    return { destroy(){ clearTimeout(timer); div.remove(); } };
  }

  async function meta(){
    try{
      const r = await fetch(API, { headers: { "X-Session-Id": sessionId, "X-Lang": LANG }});
      const m = await r.json();
      addBubble(I18N.hello);
      (m.suggested||[]).forEach(c => {
        const el = document.createElement("span");
        el.className = "chip";
        el.textContent = c.label;
        el.onclick = () => send(c.label);
        chipsEl.appendChild(el);
      });
    }catch{
      addBubble(I18N.error_server);
    }
  }

  // Skicka (SSE + fallback)
  async function send(text){
    if (!text?.trim()) return;
    addBubble(text, "me");
    inp.value = "";

    const bubble = addBubble("", "bot");
    const typing = typingBubble();
    let gotAnyToken = false;

    btn.disabled = true; btn.textContent = I18N.send + "‚Ä¶";

    try{
      const r = await fetch(API + "?stream=1", {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "X-Session-Id": sessionId,
          "X-Lang": LANG,
          "Accept":"text/event-stream"
        },
        body: JSON.stringify({ message: text })
      });

      const ct = (r.headers.get("content-type") || "").toLowerCase();

      if (!ct.includes("text/event-stream")) {
        const data = await r.json();
        typing.destroy();
        bubble.textContent = data.reply || I18N.error_tech;
        if (data.citations?.length) {
          data.citations.forEach(c=>{
            const a = document.createElement("a");
            a.href = c.url; a.target="_blank"; a.rel="noreferrer"; a.className="cite link";
            a.textContent = `[${c.id}] ${c.title}`;
            bubble.appendChild(a);
          });
          footnote.style.display = "block";
        }
        if (data.action === "open_url" && data.url) window.open(data.url, "_blank", "noopener,noreferrer");
        if (data.action === "open_contact_form") toggleModal(true);
        btn.disabled = false; btn.textContent = I18N.send;
        return;
      }

      if (!r.body) throw new Error("No stream body");
      const reader = r.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buf = "";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buf += decoder.decode(value, { stream:true });

        let idx;
        while ((idx = buf.indexOf("\n\n")) >= 0) {
          const raw = buf.slice(0, idx);
          buf = buf.slice(idx + 2);

          const lines = raw.split(/\r?\n/);
          let event = "message", data = "";
          for (const line of lines) {
            if (line.startsWith("event:")) event = line.slice(6).trim();
            else if (line.startsWith("data:")) {
              // beh√•ll mellanslag i token-data
              let payload = line.slice(5);
              if (payload.startsWith(" ")) payload = payload.slice(1);
              data += payload;
            }
          }
          if (!data) continue;

          if (event === "token") {
            if (!gotAnyToken) { typing.destroy(); gotAnyToken = true; }
            bubble.innerText += data;   // innerText bevarar mellanrum/rader
            log.scrollTo({ top: log.scrollHeight });
          }
          else if (event === "action") {
            try {
              const a = JSON.parse(data);
              if (a.action === "open_url" && a.url) window.open(a.url, "_blank", "noopener,noreferrer");
              if (a.action === "open_contact_form") toggleModal(true);
            } catch {}
          }
          else if (event === "final") {
            typing.destroy();
            try {
              const f = JSON.parse(data);
              if (!gotAnyToken && f.reply) bubble.innerText = f.reply;
              if (f.citations?.length) {
                f.citations.forEach(c=>{
                  const a = document.createElement("a");
                  a.href = c.url; a.target="_blank"; a.rel="noreferrer"; a.className="cite link";
                  a.textContent = `[${c.id}] ${c.title}`;
                  bubble.appendChild(a);
                });
                footnote.style.display = "block";
              }
            } catch {}
          }
          else if (event === "error") {
            typing.destroy();
            bubble.textContent = I18N.error_tech;
          }
        }
      }
    }catch(err){
      typing.destroy();
      bubble.textContent = I18N.error_tech;
    } finally {
      btn.disabled = false; btn.textContent = I18N.send;
    }
  }

  async function submitContact(){
    const name = fName.value.trim();
    const email = fEmail.value.trim();
    const message = fMsg.value.trim();
    if (!name || !email) { alert(I18N.error_tech); return; }
    try{
      const r = await fetch(API, {
        method: "POST",
        headers: { "Content-Type":"application/json", "X-Session-Id": sessionId, "X-Lang": LANG },
        body: JSON.stringify({ contact: { name, email, message} })
      });
      if (r.ok){
        toggleModal(false);
        addBubble(LANG==="sv" ? "Tack! Vi h√∂r av oss inom kort üíô" :
                 LANG==="no" ? "Takk! Vi tar kontakt snart üíô" :
                               "Thanks! We‚Äôll get back to you shortly üíô");
        fName.value = ""; fEmail.value = ""; fMsg.value = "";
      } else {
        addBubble(I18N.error_tech, "bot");
      }
    }catch{
      addBubble(I18N.error_tech, "bot");
    }
  }

  // Bindningar + start
  $("btn").addEventListener("click", () => send($("inp").value));
  $("inp").addEventListener("keydown", (e) => { if (e.key === "Enter") send(e.target.value); });
  meta();
});
</script>
</body>
</html>
