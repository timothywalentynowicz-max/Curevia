<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curevia â€“ Chat</title>
  <style>
    body { font-family: system-ui, Arial; background: var(--bg); margin:0 }
    :root {
      --bg: #f8fafc;
      --bot: #f1f5f9;
      --me: #2563eb;
      --text: #0f172a;
      --bubble-text: #111827;
    }
    body.dark {
      --bg: #0f172a;
      --bot: #1e293b;
      --me: #3b82f6;
      --text: #f8fafc;
      --bubble-text: #f8fafc;
    }
    .wrap { max-width:720px;margin:0 auto;padding:24px }
    .bubble { padding:12px 14px; border-radius:16px; margin:8px 0; max-width:80%; white-space:pre-wrap; }
    .bot { background:var(--bot); color:var(--bubble-text); border-top-left-radius:4px }
    .me { background:var(--me); color:#fff; margin-left:auto; border-top-right-radius:4px }
    .row { display:flex; gap:8px; position:sticky; bottom:0; background:var(--bg); padding:8px 0 }
    input { flex:1; padding:12px; border:1px solid #cbd5e1; border-radius:12px }
    button { padding:12px 16px; border:0; border-radius:12px; background:#111827; color:white; cursor:pointer }
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{background:#e2e8f0;border-radius:999px;padding:6px 10px;font-size:14px;cursor:pointer}
    .dark-toggle { position:absolute; top:10px; right:10px; }
    .copy-btn { font-size:12px; margin-top:4px; cursor:pointer; color:gray }
  </style>
</head>
<body>
  <div class="wrap">
    <h3>Curevia Assistant <button id="darkToggle" class="dark-toggle">MÃ¶rkt lÃ¤ge</button></h3>
    <div id="log"></div>
    <div id="chips" class="chips"></div>
    <div class="row">
      <input id="inp" placeholder="Skriv ett meddelande..." />
      <button id="btn" type="button">Skicka</button>
    </div>
  </div>

<script>
const API = "/api/curevia-chat";   // âœ… rÃ¤tt API-rad

const log = document.getElementById("log");
const chipsEl = document.getElementById("chips");
const inp = document.getElementById("inp");
const btn = document.getElementById("btn");
const darkToggle = document.getElementById("darkToggle");
const sessionId = self.crypto?.randomUUID?.() || "sess-" + Date.now();

function addBubble(text, who="bot"){
  const div = document.createElement("div");
  div.className = "bubble " + (who==="me"?"me":"bot");
  div.innerText = text;
  if (who !== "me" && text.length > 120) {
    const copyBtn = document.createElement("div");
    copyBtn.className = "copy-btn";
    copyBtn.textContent = "ðŸ“‹ Kopiera";
    copyBtn.onclick = () => navigator.clipboard.writeText(text);
    div.appendChild(copyBtn);
  }
  log.appendChild(div);
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}

async function meta(){
  try {
    const r = await fetch(API, { headers: { "X-Session-Id": sessionId }});
    const m = await r.json().catch(()=>({ suggested:[] }));
    addBubble("Hej! ðŸ‘‹ Hur kan jag hjÃ¤lpa till idag?");
    (m.suggested||[]).forEach(c => {
      const el = document.createElement("span");
      el.className = "chip";
      el.textContent = c.label;
      el.onclick = () => send(c.label);
      chipsEl.appendChild(el);
    });
  } catch(e) {
    addBubble("Kunde inte nÃ¥ servern just nu.");
  }
}

async function send(text){
  if (!text.trim()) return;
  addBubble(text, "me");
  inp.value = "";

  const bubble = document.createElement("div");
  bubble.className = "bubble bot";
  log.appendChild(bubble);

  const typing = document.createElement("span");
  typing.textContent = "â€¦";
  bubble.appendChild(typing);

  try {
    const r = await fetch(API + "?stream=1", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "X-Session-Id": sessionId,
        "X-Lang": navigator.language || "sv"
      },
      body: JSON.stringify({ message: text })
    });

    const ct = (r.headers.get("content-type") || "").toLowerCase();
    if (!ct.includes("text/event-stream")) {
      typing.remove();
      bubble.innerText = "Ett fel uppstod nÃ¤r jag fÃ¶rsÃ¶kte nÃ¥ servern.";
      return;
    }

    const reader = r.body.getReader();
    const decoder = new TextDecoder();
    let done = false;
    let fullText = "";

    while(!done){
      const {value, done:doneNow} = await reader.read();
      done = doneNow;
      if (value){
        const chunk = decoder.decode(value, {stream: true});
        const lines = chunk.split(/\r?\n/);
        for (const line of lines){
          if (!line) continue;
          if (line.startsWith("data:")){
            let payload = line.slice(5);
            if (payload.startsWith(" ")) payload = payload.slice(1);
            if (payload === "[DONE]") continue;
            try {
              const json = JSON.parse(payload);
              const delta = json.choices?.[0]?.delta?.content;
              if (delta){
                fullText += delta;
                typing.remove();
                bubble.innerText = fullText; // âœ… behÃ¥ller mellanslag
              }
            } catch(e){}
          }
        }
      }
    }

    if (fullText.length > 120) {
      const copyBtn = document.createElement("div");
      copyBtn.className = "copy-btn";
      copyBtn.textContent = "ðŸ“‹ Kopiera";
      copyBtn.onclick = () => navigator.clipboard.writeText(fullText);
      bubble.appendChild(copyBtn);
    }

  } catch(e) {
    typing.remove();
    bubble.innerText = "Kunde inte fÃ¥ svar just nu.";
  }
}

document.addEventListener("DOMContentLoaded", () => {
  btn.addEventListener("click", () => send(inp.value));
  inp.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(inp.value); });
  darkToggle.addEventListener("click", () => {
    document.body.classList.toggle("dark");
  });
  meta();
});
</script>
</body>
</html>
