<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curevia – Chat</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --bot:#f1f5f9; --user:#2563eb; --text:#0f172a; --muted:#64748b;
      --border:#e2e8f0; --chip:#e2e8f0; --chip-b:#cbd5e1; --btn:#0f172a; --shadow:0 6px 24px rgba(15,23,42,.06);
      --radius:18px;
    }
    /* Dark mode overrides */
    .dark{
      --bg:#0b1220; --card:#0f172a; --bot:#0b1a33; --user:#3b82f6; --text:#e5e7eb; --muted:#94a3b8;
      --border:#1f2a44; --chip:#12203a; --chip-b:#213050; --btn:#111827; --shadow:0 6px 24px rgba(2,6,23,.4);
    }

    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);margin:0;color:var(--text)}
    .shell{max-width:820px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:#0ea5e9}
    .title{font-weight:700}
    .subtitle{font-size:12px;color:var(--muted)}
    .toggle{border:1px solid var(--border); background:var(--card); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer}

    .card{background:var(--card);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .chips{display:flex;gap:8px;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid var(--border);background:color-mix(in srgb, var(--card) 80%, var(--bg))}
    .chip{background:var(--chip);border:1px solid var(--chip-b);border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer}
    .log{height:58vh;overflow:auto;padding:16px}
    .bubble{position:relative;padding:12px 40px 12px 14px;border-radius:var(--radius);margin:8px 0;max-width:80%;line-height:1.35;white-space:pre-wrap;word-wrap:break-word}
    .bot{background:var(--bot);border-top-left-radius:8px}
    .me{background:var(--user);color:#fff;margin-left:auto;border-top-right-radius:8px}
    .cite{display:block;font-size:11px;margin-top:6px;opacity:.75}
    .row{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border);background:var(--card)}
    .in{flex:1;padding:12px 14px;border:1px solid var(--chip-b);background:transparent;color:var(--text);border-radius:14px}
    .btn{padding:12px 16px;border:0;border-radius:14px;background:var(--btn);color:#fff;cursor:pointer}
    .foot{font-size:12px;color:var(--muted);padding:8px 16px;background:var(--card);border-top:1px solid var(--border)}
    @media (max-width:640px){ .log{height:60vh} }

    /* Typing animation */
    .typing-wrap{display:inline-flex;gap:6px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#94a3b8;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{ 0%,100%{opacity:.25;transform:translateY(0)} 20%{opacity:1;transform:translateY(-2px)} }

    /* Copy button */
    .copy{
      position:absolute; right:8px; top:8px;
      border:1px solid var(--chip-b); background:transparent; color:var(--muted);
      border-radius:10px; padding:4px 8px; font-size:12px; cursor:pointer;
    }
    .copy.ok{ color:#16a34a; border-color:#16a34a }
    .copy.err{ color:#ef4444; border-color:#ef4444 }

    /* Modal */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,.4);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{background:var(--card);color:var(--text);border-radius:16px;box-shadow:var(--shadow);max-width:520px;width:100%;border:1px solid var(--border)}
    .modal .head{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
    .modal .body{padding:16px}
    .modal .row{display:flex;gap:8px;padding:0;border:0;background:none}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field input,.field textarea{padding:10px;border:1px solid var(--chip-b);border-radius:12px;width:100%;background:transparent;color:var(--text)}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;padding:14px 16px;border-top:1px solid var(--border)}
    .link{color:#3b82f6;text-decoration:underline}
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Curevia Assistant</div>
          <div class="subtitle">Snabb hjälp • Demo när du vill</div>
        </div>
      </div>
      <button id="theme" class="toggle" aria-label="Växla mörkt läge">🌗 Mörkt läge</button>
    </div>

    <div class="card">
      <div id="chips" class="chips"></div>

      <div id="log" class="log"></div>

      <div class="row">
        <input id="inp" class="in" placeholder="Ställ en fråga…" />
        <button id="btn" class="btn">Skicka</button>
      </div>

      <div class="foot" id="footnote" style="display:none">
        Botten använder Curevias källor för att svara korrekt.
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div id="backdrop" class="modal-back" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="head">Lämna dina uppgifter</div>
      <div class="body">
        <div class="field">
          <label for="name">Namn</label>
          <input id="name" placeholder="För- och efternamn" />
        </div>
        <div class="field">
          <label for="email">E-post</label>
          <input id="email" placeholder="namn@exempel.se" />
        </div>
        <div class="field">
          <label for="msg">Meddelande (valfritt)</label>
          <textarea id="msg" rows="3" placeholder="Kort rad om vad du vill prata om"></textarea>
        </div>
      </div>
      <div class="actions">
        <button id="cancel" class="btn" style="background:var(--chip);color:var(--text)">Avbryt</button>
        <button id="send" class="btn">Skicka</button>
      </div>
    </div>
  </div>

<script>
const API = "/api/curevia-chat";
const log = document.getElementById("log");
const chipsEl = document.getElementById("chips");
const inp = document.getElementById("inp");
const btn = document.getElementById("btn");
const footnote = document.getElementById("footnote");
const themeBtn = document.getElementById("theme");
const sessionId = self.crypto?.randomUUID?.() || ("sess-" + Date.now());

// ----- Dark mode toggle (sparas i localStorage)
(function initTheme(){
  const saved = localStorage.getItem("cv_theme");
  if (saved === "dark") document.documentElement.classList.add("dark");
  themeBtn.textContent = document.documentElement.classList.contains("dark") ? "☀️ Ljust läge" : "🌗 Mörkt läge";
})();
themeBtn.onclick = () => {
  document.documentElement.classList.toggle("dark");
  const isDark = document.documentElement.classList.contains("dark");
  localStorage.setItem("cv_theme", isDark ? "dark" : "light");
  themeBtn.textContent = isDark ? "☀️ Ljust läge" : "🌗 Mörkt läge";
};

// Modal refs
const backdrop = document.getElementById("backdrop");
const fName = document.getElementById("name");
const fEmail = document.getElementById("email");
const fMsg = document.getElementById("msg");
document.getElementById("cancel").onclick = ()=> toggleModal(false);
document.getElementById("send").onclick = submitContact;

function toggleModal(open){ backdrop.style.display = open ? "flex" : "none"; }

// Hjälpfunktion: lägg till kopiera-knapp på bot-bubblor
function attachCopyButton(div){
  const btn = document.createElement("button");
  btn.className = "copy";
  btn.textContent = "Kopiera";
  btn.title = "Kopiera svar";
  btn.onclick = async (e)=>{
    e.stopPropagation();
    try{
      // kopiera endast själva svaret, inte citations-länkarna
      const text = div.childNodes[0]?.nodeValue || div.innerText;
      await navigator.clipboard.writeText(text.trim());
      btn.classList.remove("err"); btn.classList.add("ok"); btn.textContent = "Kopierat ✓";
      setTimeout(()=>{ btn.classList.remove("ok"); btn.textContent = "Kopiera"; }, 1500);
    }catch{
      btn.classList.remove("ok"); btn.classList.add("err"); btn.textContent = "Fel";
      setTimeout(()=>{ btn.classList.remove("err"); btn.textContent = "Kopiera"; }, 1500);
    }
  };
  div.appendChild(btn);
}

function addBubble(text, who="bot", citations){
  const div = document.createElement("div");
  div.className = "bubble " + (who==="me"?"me":"bot");
  div.textContent = text;
  if (who !== "me") attachCopyButton(div);
  if (citations && citations.length){
    citations.forEach(c=>{
      const a = document.createElement("a");
      a.href = c.url; a.target="_blank"; a.rel="noreferrer"; a.className="cite link";
      a.textContent = `[${c.id}] ${c.title}`;
      div.appendChild(a);
    });
    footnote.style.display = "block";
  }
  log.appendChild(div);
  log.scrollTo({ top: log.scrollHeight, behavior: "smooth" });
  return div;
}

/* Typing bubble (visas tills vi får svar) */
function typingBubble(){
  const div = document.createElement("div");
  div.className = "bubble bot";
  const wrap = document.createElement("div");
  wrap.className = "typing-wrap";
  wrap.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  div.appendChild(wrap);
  attachCopyButton(div); // visuellt konsekvent (gör inget om man kopierar “...”)
  log.appendChild(div);
  log.scrollTo({ top: log.scrollHeight, behavior: "smooth" });
  let timer = setTimeout(()=>{ div.remove(); }, 30000);
  return { destroy(){ clearTimeout(timer); div.remove(); } };
}

async function meta(){
  try{
    const r = await fetch(API, { headers: { "X-Session-Id": sessionId }});
    const m = await r.json();
    addBubble("Hej! 👋 Jag är Curevia-boten – hur kan jag hjälpa till idag?");
    (m.suggested||[]).forEach(c => {
      const el = document.createElement("span");
      el.className = "chip";
      el.textContent = c.label;
      el.onclick = () => send(c.label);
      chipsEl.appendChild(el);
    });
  }catch{
    addBubble("Jag nådde inte servern just nu – prova igen om en stund 🙏");
  }
}

/* --------- Skicka med SSE + fallback till JSON ---------- */
async function send(text){
  if (!text?.trim()) return;
  addBubble(text, "me");
  inp.value = "";

  // Förbered en bot-bubbla som vi fyller på
  const bubble = addBubble("", "bot");
  const typing = typingBubble();
  let gotAnyToken = false;

  try{
    const r = await fetch(API + "?stream=1", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "X-Session-Id": sessionId,
        "Accept":"text/event-stream"
      },
      body: JSON.stringify({ message: text })
    });

    const ct = (r.headers.get("content-type") || "").toLowerCase();

    // 🔁 FALLBACK: om backend INTE skickar SSE (snabb-QA), hantera som JSON
    if (!ct.includes("text/event-stream")) {
      const data = await r.json();
      typing.destroy();
      bubble.textContent = data.reply || "Oj, något gick fel.";
      if (data.citations?.length) {
        data.citations.forEach(c=>{
          const a = document.createElement("a");
          a.href = c.url; a.target="_blank"; a.rel="noreferrer"; a.className="cite link";
          a.textContent = `[${c.id}] ${c.title}`;
          bubble.appendChild(a);
        });
        footnote.style.display = "block";
      }
      if (data.action === "open_url" && data.url) window.open(data.url, "_blank", "noopener,noreferrer");
      if (data.action === "open_contact_form") toggleModal(true);
      return;
    }

    // ✅ SSE-väg
    if (!r.body) throw new Error("No stream body");
    const reader = r.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buf = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream:true });

      let idx;
      while ((idx = buf.indexOf("\n\n")) >= 0) {
        const raw = buf.slice(0, idx);
        buf = buf.slice(idx + 2);

        const lines = raw.split(/\r?\n/);
        let event = "message", data = "";
        for (const line of lines
