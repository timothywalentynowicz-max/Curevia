<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curevia â€“ Chat</title>
  <style>
    :root{ --bg:#f8fafc; --bot:#eef2ff; --me:#2563eb; --text:#0f172a; --border:#cbd5e1; }
    *{ box-sizing:border-box }
    body{ font-family:system-ui,Arial; background:var(--bg); color:var(--text); margin:0 }
    .wrap{ max-width:420px; margin:12px auto; padding:12px }
    h3{ margin:0 0 10px; display:flex; align-items:center; justify-content:space-between }
    .toggle{ border:1px solid var(--border); background:#fff; color:#111827; border-radius:999px; padding:6px 10px; cursor:pointer }

    #log{ max-height:70vh; overflow:auto; padding-bottom:8px }
    .bubble{ padding:10px 12px; border-radius:16px; margin:8px 0; max-width:90%; white-space:pre-wrap; line-height:1.35 }
    .bot{ background:var(--bot); border-top-left-radius:6px }
    .me{ background:var(--me); color:#fff; margin-left:auto; border-top-right-radius:6px }
    .copy{ font-size:12px; color:#64748b; margin-top:4px; cursor:pointer }

    .row{ display:flex; gap:8px; position:sticky; bottom:0; background:var(--bg); padding:8px 0; border-top:1px solid var(--border) }
    input{ flex:1; padding:12px; border:1px solid var(--border); border-radius:12px }
    button{ padding:12px 16px; border:0; border-radius:12px; background:#111827; color:#fff; cursor:pointer }

    /* MÃ¶rkt lÃ¤ge */
    body.dark{ --bg:#0f172a; --bot:#1e293b; --text:#f8fafc; --border:#334155 }
    body.dark .toggle{ background:#0b1220; color:#f8fafc; border-color:#334155 }

    /* Mobil */
    @media (max-width:520px){
      .wrap{ margin:8px auto; padding:8px }
      #log{ max-height:68vh }
      .bubble{ max-width:100% }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h3>
      <span>Curevia Assistant</span>
      <button id="dark" class="toggle" type="button">MÃ¶rkt lÃ¤ge</button>
    </h3>

    <div id="log"></div>

    <div class="row">
      <input id="inp" placeholder="Skriv ett meddelande..." />
      <button id="btn" type="button">Skicka</button>
    </div>
  </div>

<script>
/* ===== Config ===== */
const API = "/api/curevia-chat";
const sessionId = self.crypto?.randomUUID?.() || ("sess-" + Date.now());

/* ===== DOM ===== */
const log   = document.getElementById("log");
const inp   = document.getElementById("inp");
const btn   = document.getElementById("btn");
const dark  = document.getElementById("dark");

/* ===== UI helpers ===== */
function addBubble(text, who="bot"){
  const div = document.createElement("div");
  div.className = "bubble " + (who==="me" ? "me" : "bot");
  div.innerText = text || "";
  if (who !== "me" && (text||"").length > 120){
    const cp = document.createElement("div");
    cp.className = "copy";
    cp.textContent = "ðŸ“‹ Kopiera";
    cp.onclick = () => navigator.clipboard.writeText(div.innerText);
    div.appendChild(cp);
  }
  log.appendChild(div);
  log.scrollTo({ top: log.scrollHeight, behavior: "smooth" });
  return div;
}
function typingBubble(){ const b = addBubble("â€¦","bot"); return { destroy(){ try{ b.remove(); }catch{} } }; }
function openNewTab(url){ try { window.open(url, "_blank", "noopener,noreferrer"); } catch {} }
function firstUrlIn(text){ const m = String(text||"").match(/https?:\/\/[^\s)]+/i); return m ? m[0] : null; }

/* ===== Dark mode ===== */
dark.onclick = () => document.body.classList.toggle("dark");

/* ===== Boot ===== */
boot();
async function boot(){
  try{
    const r = await fetch(API, { headers: { "X-Session-Id": sessionId }});
    const ok = (r.headers.get("content-type")||"").toLowerCase().includes("application/json");
    if (!ok) throw new Error("meta");
    await r.json();
    addBubble("Hej! ðŸ‘‹ Hur kan jag hjÃ¤lpa till idag?");
  }catch{
    addBubble("Jag nÃ¥dde inte servern just nu â€“ prova igen om en stund ðŸ™");
  }
}

/* ===== Send ===== */
let lastUserText = "";
btn.onclick = ()=> send(inp.value);
inp.addEventListener("keydown", e => { if (e.key==="Enter") send(inp.value); });

async function send(text){
  if (!text || !text.trim()) return;
  lastUserText = text;
  addBubble(text, "me");
  inp.value = "";

  const bubble = addBubble("", "bot");
  const typing = typingBubble();
  let gotAnyToken = false;
  let finalText = "";

  try {
    const r = await fetch(API + "?stream=1", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "X-Session-Id": sessionId,
        "X-Lang": navigator.language || "",
        "Accept":"text/event-stream"
      },
      body: JSON.stringify({ message: text })
    });

    const ct = (r.headers.get("content-type") || "").toLowerCase();

    // Om vi inte fÃ¥r SSE: hantera JSON och Ã¶ppna ev. lÃ¤nk
    if (!ct.includes("text/event-stream")) {
      const safe = ct.includes("application/json");
      typing.destroy();
      if (safe) {
        const data = await r.json();
        bubble.innerText = data.reply || "Tekniskt fel â€“ prova igen.";
        if (data.action === "open_url" && data.url) {
          openNewTab(data.url);                       // Ã¶ppna via action
        } else {
          const url = firstUrlIn(data.reply);
          if (url && /demo|book|boka/i.test(lastUserText)) openNewTab(url); // fallback
        }
      } else {
        bubble.innerText = "Tekniskt fel â€“ prova igen.";
      }
      return;
    }

    // === Robust SSE-parser: token/final/action + OpenAI-fallback
    const reader = r.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";

    while (true){
      const { value, done } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream:true });

      let idx;
      while ((idx = buffer.indexOf("\n\n")) >= 0) {
        const raw = buffer.slice(0, idx);
        buffer = buffer.slice(idx + 2);

        const lines = raw.split(/\r?\n/);
        let event = "message";
        let data  = "";

        for (const line of lines){
          if (!line) continue;
          if (line.startsWith("event:")) event = line.slice(6).trim();
          else if (line.startsWith("data:")) {
            let payload = line.slice(5);
            if (payload.startsWith(" ")) payload = payload.slice(1);
            data += payload;
          }
        }
        if (!data) continue;

        // Direkt action frÃ¥n backend (Ã¶ppna URL i ny flik)
        if (event === "action") {
          try {
            const a = JSON.parse(data);
            if (a?.action === "open_url" && a.url) openNewTab(a.url);
          } catch {}
          continue;
        }

        if (event === "token") {
          if (!gotAnyToken) { typing.destroy(); gotAnyToken = true; }
          bubble.innerText += data; finalText += data;
          log.scrollTo({ top: log.scrollHeight });
          continue;
        }

        if (event === "final") {
          typing.destroy();
          try {
            const j = JSON.parse(data);
            if (!gotAnyToken && j.reply) { bubble.innerText = j.reply; finalText = j.reply; }
          } catch {
            if (!gotAnyToken) { bubble.innerText = data; finalText = data; }
          }
          continue;
        }

        // OpenAI rÃ¥stream fallback
        try{
          const j = JSON.parse(data);
          const delta = j?.choices?.[0]?.delta?.content;
          if (delta){
            if (!gotAnyToken) { typing.destroy(); gotAnyToken = true; }
            bubble.innerText += delta; finalText += delta;
          }
        }catch{}
      }
    }

    if (!gotAnyToken && !bubble.innerText) { typing.destroy(); bubble.innerText = "Inget svar â€“ prova igen."; }

    // Fallback: om frÃ¥gan gÃ¤llde demo och svaret har lÃ¤nk, Ã¶ppna den
    const maybeUrl = firstUrlIn(finalText);
    if (maybeUrl && /demo|book|boka/i.test(lastUserText)) openNewTab(maybeUrl);

    // Kopiera-knapp fÃ¶r lÃ¥nga svar
    if (bubble.innerText.length > 120){
      const cp = document.createElement("div");
      cp.className = "copy";
      cp.textContent = "ðŸ“‹ Kopiera";
      cp.onclick = () => navigator.clipboard.writeText(bubble.innerText);
      bubble.appendChild(cp);
    }

  } catch(e) {
    typing.destroy();
    bubble.innerText = "Tekniskt fel â€“ prova igen.";
  }
}
</script>
</body>
</html>
