<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Curevia ‚Äì Chat</title>
  <style>
    :root{ --bg:#f8fafc; --bot:#eef2ff; --me:#2563eb; --text:#0f172a; --border:#cbd5e1; --focus:#94a3b8; --toast:#111827; --toastText:#fff; }
    *{ box-sizing:border-box }
    body{ font-family:system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); margin:0 }
    .wrap{ max-width:520px; margin:12px auto; padding:12px }
    h3{ margin:0 0 10px; display:flex; align-items:center; justify-content:space-between; gap:8px }
    .toggle{ border:1px solid var(--border); background:#fff; color:#111827; border-radius:999px; padding:6px 12px; cursor:pointer }
    .toggle:focus-visible{ outline:3px solid var(--focus); outline-offset:2px }

    #log{ max-height:70vh; overflow:auto; padding-bottom:8px }
    .bubble{ padding:10px 12px; border-radius:16px; margin:8px 0; max-width:90%; white-space:pre-wrap; line-height:1.35; position:relative }
    .bot{ background:var(--bot); border-top-left-radius:6px }
    .me{ background:var(--me); color:#fff; margin-left:auto; border-top-right-radius:6px }
    .copy{ font-size:12px; color:#64748b; margin-top:6px; cursor:pointer; user-select:none }

    .row{ display:flex; gap:8px; position:sticky; bottom:0; background:var(--bg); padding:8px 0; border-top:1px solid var(--border) }
    input[type="text"]{ flex:1; padding:12px; border:1px solid var(--border); border-radius:12px }
    button.primary{ padding:12px 16px; border:0; border-radius:12px; background:#111827; color:#fff; cursor:pointer }
    button.primary:disabled{ opacity:.6; cursor:not-allowed }
    button.primary:focus-visible{ outline:3px solid var(--focus); outline-offset:2px }

    /* Suggestions / Chips */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 2px }
    .chip{
      display:inline-flex; align-items:center; gap:.5rem;
      background:#fff; border:1px solid var(--border);
      border-radius:999px; padding:.6rem .9rem;
      font-size:14px; font-weight:600; cursor:pointer;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      transition:transform .02s ease-in, box-shadow .12s ease;
    }
    .chip .emoji{ font-size:1.1rem; line-height:1 }
    .chip .label{ line-height:1; white-space:nowrap }
    .chip:hover{ transform:translateY(-1px); box-shadow:0 2px 6px rgba(0,0,0,.06) }
    .chip:focus-visible{ outline:3px solid var(--focus); outline-offset:2px }
    body.dark .chip{ background:#0b1220; color:#f8fafc; border-color:#334155 }

    /* Modal (contact form) */
    .modal-bg{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ width:92%; max-width:420px; background:#fff; color:#0f172a; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2) }
    .modal h4{ margin:0 0 10px }
    .modal .g{ display:grid; gap:8px }
    .modal input, .modal textarea{ width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px }
    .modal .btn{ padding:10px 14px; border:0; border-radius:10px; cursor:pointer }
    .btn-primary{ background:#111827; color:#fff }
    .btn-ghost{ background:#fff; border:1px solid #cbd5e1 }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background:var(--toast); color:var(--toastText);
      padding:10px 14px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.18);
      opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;
      z-index:60; font-size:14px; max-width:90vw; text-align:center;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px) }

    /* Dark */
    body.dark{ --bg:#0f172a; --bot:#1e293b; --text:#f8fafc; --border:#334155; --toast:#0b1220; --toastText:#f8fafc; }
    body.dark .toggle{ background:#0b1220; color:#f8fafc; border-color:#334155 }
    body.dark .modal{ background:#0b1220; color:#f8fafc }
    body.dark .modal input, body.dark .modal textarea{ background:#0b1220; color:#f8fafc; border-color:#334155 }

    @media (max-width:520px){
      .wrap{ margin:8px auto; padding:8px }
      #log{ max-height:68vh }
      .bubble{ max-width:100% }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h3>
      <span>Curevia Assistant</span>
      <button id="dark" class="toggle" type="button" aria-pressed="false" aria-label="V√§xla m√∂rkt l√§ge">M√∂rkt l√§ge</button>
    </h3>

    <div id="log" aria-live="polite" aria-atomic="false"></div>

    <div class="row">
      <input id="inp" type="text" placeholder="Skriv ett meddelande..." autocomplete="off" />
      <button id="btn" class="primary" type="button" disabled>Skicka</button>
    </div>
  </div>

  <!-- Contact modal -->
  <div id="modalBg" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <div class="modal">
      <h4 id="contactTitle">L√§mna dina uppgifter</h4>
      <div class="g">
        <input id="cName"  placeholder="Namn" />
        <input id="cEmail" placeholder="E-post" />
        <input id="cPhone" placeholder="Telefon (valfritt)" />
        <textarea id="cMsg"  rows="4" placeholder="Kort meddelande (valfritt)"></textarea>
      </div>
      <div class="actions">
        <button id="cCancel" class="btn btn-ghost" type="button">Avbryt</button>
        <button id="cSend"   class="btn btn-primary" type="button">Skicka</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
/* =========================================================
   CONFIG & CONSTANTS
========================================================= */
const API = "/api/curevia-chat"; // server-fallback (GPT-5)
const sessionId = self.crypto?.randomUUID?.() || ("sess-" + Date.now());
const LINKS = {
  demo:"https://calendly.com/tim-curevia/30min",
  regConsult:"https://curevia.ai/consultant/register",
  regProvider:"https://curevia.ai/auth?type=signup&returnTo=/employer/register"
};

// Kalkyl ‚Äì defaults (kan ers√§ttas av server/env via /api om du vill)
const DEFAULTS = {
  platformFeePct: 0.05,   // 5%
  agPct: 0.3142,          // 31,42% arbetsgivaravgift
  taxPct: 0.32,           // 32% schablon
  vacationPct: 0.12       // 12% semesterp√•slag (kan s√§ttas 0)
};

/* =========================================================
   COMPREHENSIVE FAQ (robust p√• klientsidan)
   OBS: l√§gg till nya fr√•gor l√§ngst ner ‚Äì ta aldrig bort.
========================================================= */
const CureviaFAQs = [
  // OM CUREVIA
  { q:"Vilket f√∂retag st√•r bakom Curevia?", a:"Curevia drivs av Nenetka AB ‚Äì en svensk plattform som matchar v√•rdpersonal med uppdrag. Enkelt, tryggt och utan kr√•ngel." },
  { q:"Vad √§r Curevia?", a:"En digital marknadsplats f√∂r v√•rden. V√•rdpersonal hittar uppdrag och v√•rdgivare hittar kompetens ‚Äì helt digitalt." },
  { q:"√Ñr Curevia ett bemanningsf√∂retag?", a:"Vi √§r en plattform/marknadsplats snarare √§n ett traditionellt bemanningsbolag, vilket ger transparens och snabbare processer." },
  { q:"Vilka kan anv√§nda Curevia?", a:"Legitimerad v√•rdpersonal och v√•rdgivare/kliniker i behov av bemanning." },
  { q:"Var finns ni?", a:"Vi √§r baserade i Sverige och expanderar stegvis. Fr√•ga oss om din region." },
  { q:"√Ñr Curevia godk√§nt av myndigheter?", a:"Vi f√∂ljer g√§llande regelverk och GDPR, och verifierar legitimation innan uppdrag." },
  { q:"Tar ni provision fr√•n v√•rdpersonalens l√∂n?", a:"Vi tar en transparent plattformsavgift p√• fakturabeloppet exkl. moms enligt avtal ‚Äì ers√§ttningen syns tydligt i kalkylen." },
  { q:"Vad skiljer er fr√•n klassiska bemanningsbolag?", a:"Digitalt fl√∂de, mer valfrihet och snabb matchning. Mindre friktion, mer kontroll." },
  { q:"Har ni kollektivavtal?", a:"Villkor beror p√• uppdragsform. Be oss om underlag f√∂r just din situation." },
  { q:"Jobbar ni bara i Sverige?", a:"Prim√§rt i Sverige just nu, men vi bygger broar mellan europeiska l√§nder stegvis." },

  // REGISTRERING & PROFIL
  { q:"Hur registrerar jag mig som konsult?", a:"Skapa konto, fyll i profil och ladda upp legitimation/intyg. Boten guidar dig steg f√∂r steg." },
  { q:"Hur registrerar sig en v√•rdgivare?", a:"Skapa konto, l√§gg in behov (kompetens, datum, villkor) och signera digitalt n√§r matchen √§r klar." },
  { q:"Vilka dokument beh√∂ver jag som konsult?", a:"Legitimation, CV, eventuella intyg och referenser. Ladda upp i din profil s√• kan vi verifiera." },
  { q:"Hur verifieras min legitimation?", a:"Vi kontrollerar legitimation mot tillg√§ngliga register och beg√§r kompletteringar vid behov." },
  { q:"Kan jag pausa min profil?", a:"Ja, du kan d√∂lja eller pausa din profil n√§r du inte √§r tillg√§nglig." },
  { q:"Hur uppdaterar jag mina uppgifter?", a:"G√• till Profil ‚Üí Redigera. √Ñndringar sl√•r igenom direkt efter sparning." },

  // F√ñR KONSULTER ‚Äì ARBETSS√ÑTT
  { q:"Hur funkar det att jobba via Curevia?", a:"Skapa profil, hitta uppdrag, signera digitalt och rapportera tid. Vi sk√∂ter administration och utbetalning." },
  { q:"M√•ste jag ha ett eget bolag?", a:"Nej. Du kan f√• l√∂n utan bolag via oss ‚Äì eller fakturera fr√•n eget AB om du f√∂redrar det." },
  { q:"Kan jag v√§lja uppdrag fritt?", a:"Ja, du v√§ljer plats, tider och villkor inom ramen f√∂r uppdraget." },
  { q:"Kan jag arbeta deltid?", a:"Absolut. Du styr sj√§lv din tillg√§nglighet och omfattning." },
  { q:"Erbjuder ni distansuppdrag?", a:"Ja, n√§r v√•rdgivaren till√•ter det. Filtrera p√• distans i uppdragslistan." },
  { q:"Hur hittar jag nya uppdrag?", a:"I din dashboard ‚Äì och via personliga rekommendationer utifr√•n din profil." },
  { q:"Hur rapporterar jag tid?", a:"Direkt i plattformen. Signera och skicka f√∂r godk√§nnande." },
  { q:"Hur snabbt f√•r jag feedback p√• en ans√∂kan?", a:"Ofta inom 24‚Äì72 timmar. Du f√•r notiser i appen." },

  // EKONOMI & ERS√ÑTTNING ‚Äì KONSULT
  { q:"Hur mycket f√•r jag ut i nettol√∂n om jag fakturerar X kr?", a:"Ange fakturabelopp exkl. moms s√• r√§knar vi brutto, skatt och nettol√∂n direkt ‚Äì med tydliga mellanled." },
  { q:"Vilken plattformsavgift tar ni?", a:"Enligt avtal, t.ex. en procentsats p√• fakturabeloppet exkl. moms. Den visas √∂ppet i kalkylen." },
  { q:"N√§r f√•r jag betalt?", a:"Vanligtvis inom 5‚Äì10 bankdagar efter godk√§nd tidrapport/faktura. Tider kan variera per uppdrag." },
  { q:"F√•r jag tj√§nstepension?", a:"Beror p√• uppdragsform. Fr√•ga oss s√• s√§tter vi upp r√§tt l√∂sning." },
  { q:"Hur funkar semesterers√§ttning?", a:"Vi kan l√§gga p√• t.ex. 12 % enligt valt uppl√§gg, eller redovisa separat ‚Äì du v√§ljer." },
  { q:"Hur funkar skatten?", a:"Vid l√∂n via oss drar vi prelimin√§r skatt enligt tabell/schablon. Med eget AB hanterar du skatt i bolaget." },
  { q:"Vad √§r skillnaden mellan l√∂n via Curevia och fakturering via AB?", a:"Med l√∂n sk√∂ter vi arbetsgivaransvar, skatter och utbetalning. Med AB fakturerar du och sk√∂ter ekonomi sj√§lv." },
  { q:"Kan jag f√• milers√§ttning och traktamente?", a:"Ja, enligt Skatteverkets regler och uppdragsavtal. Rapportera i tidrapporten s√• hanterar vi det korrekt." },
  { q:"Kan jag se exempel p√• l√∂nebesked?", a:"Ja, vi kan visa en exempel-PDF s√• du ser hur allt redovisas." },
  { q:"Hur hanteras OB och ers√§ttning f√∂r helg/kv√§ll?", a:"Enligt uppdragsavtal. Vi visar alltid ers√§ttningsniv√•erna tydligt innan du accepterar." },
  { q:"Kan jag f√• f√∂rskott?", a:"I vissa fall efter √∂verenskommelse. Fr√•ga support s√• hj√§lper vi dig." },

  // TRYGGHET & JURIDIK
  { q:"Vem st√•r f√∂r f√∂rs√§kring?", a:"F√∂rs√§kring tillhandah√•lls av v√•rdgivaren enligt uppdragets villkor. Be oss om intyg f√∂r just ditt uppdrag." },
  { q:"Vem √§r arbetsgivare?", a:"Vid l√∂n via Curevia √§r vi arbetsgivare. Fakturerar du via eget AB √§r uppdraget B2B." },
  { q:"√Ñr mina personuppgifter s√§kra?", a:"Ja, vi f√∂ljer GDPR och lagrar data s√§kert inom EU. Du kan beg√§ra utdrag eller radering n√§r som helst." },
  { q:"Hur hanterar ni k√§nslig information?", a:"Vi minimerar insamling, krypterar d√§r det kr√§vs och delar aldrig utan laglig grund." },
  { q:"Har jag r√§tt till sjukl√∂n?", a:"Beror p√• uppdragsform och avtal. Vi f√∂rklarar g√§rna vad som g√§ller i ditt specifika uppdrag." },
  { q:"Vad h√§nder om v√•rdgivaren betalar sent?", a:"Vi hanterar p√•minnelser enligt avtal. Vid l√∂n via oss p√•verkas normalt inte din utbetalning." },

  // V√ÖRDGIVARE ‚Äì BOKNING & AVTAL
  { q:"Hur l√§gger vi en f√∂rfr√•gan som v√•rdgivare?", a:"Skapa konto, ange kompetens, datum, omfattning och villkor. Vi matchar snabbt och ni signerar digitalt." },
  { q:"Vilka kompetenser kan vi boka?", a:"L√§kare, sjuksk√∂terskor (grund/specialist), undersk√∂terskor m.fl. Fr√•ga om nischade roller." },
  { q:"Hur snabbt kan ni leverera personal?", a:"Ofta inom 24‚Äì72 timmar f√∂r kortare vikariat. L√§ngre uppdrag planeras i god tid." },
  { q:"Kan vi skriva ramavtal?", a:"Ja, f√∂r b√§ttre priser, SLA och tydlig uppf√∂ljning." },
  { q:"Hur fungerar priss√§ttning?", a:"Tim- eller dygnspriser baseras p√• kompetens, plats och tider. Vi l√§mnar offert med tydlig kostnadsbild." },
  { q:"Kan vi f√∂lja uppdrag i realtid?", a:"Ja, i er dashboard ser ni status, tidrapporter och KPI:er." },
  { q:"Hur sker fakturering?", a:"Digital tidrapportering och samlad faktura enligt √∂verenskommet intervall." },
  { q:"G√∂r ni bakgrundskontroller?", a:"Ja, legitimation och referenser kontrolleras innan start." },
  { q:"Kan vi beh√∂va teckna extra f√∂rs√§kring?", a:"V√•rdgivaren ansvarar f√∂r n√∂dv√§ndiga f√∂rs√§kringar och arbetsmilj√∂ enligt lag och avtal." },

  // PRAKTISKT & APP
  { q:"Hur loggar jag in?", a:"Med e-post/telefon och eng√•ngskod eller BankID om aktiverat." },
  { q:"Jag har gl√∂mt mitt l√∂senord, vad g√∂r jag?", a:"Klicka p√• ‚ÄùGl√∂mt?‚Äù s√• skickar vi en √•terst√§llningsl√§nk eller eng√•ngskod." },
  { q:"Har ni en mobilapp?", a:"Webben √§r mobilanpassad idag. Native app √§r p√• v√§g." },
  { q:"Kan jag f√• notiser om nya uppdrag?", a:"Ja, aktivera notiser och bevakningar i din profil." },
  { q:"Kan jag exportera min historik?", a:"Ja, exportera som PDF/CSV under Historik." },
  { q:"St√∂djer ni flera spr√•k?", a:"Ja, svenska, norska, engelska och danska. Fler spr√•k kan tillkomma." },
  { q:"Kan jag bjuda in en kollega?", a:"Ja, dela din inbjudningsl√§nk ‚Äì b√•da kan f√• bonus enligt kampanjvillkor." },

  // DISTANS & ARBETSS√ÑTT
  { q:"Hur funkar distansuppdrag praktiskt?", a:"N√§r v√•rdgivaren till√•ter det sker arbetet digitalt enligt deras processer och system." },
  { q:"Vilken utrustning beh√∂ver jag f√∂r distans?", a:"S√§ker uppkoppling, kamera/mikrofon och tillg√•ng till v√•rdgivarens system enligt instruktion." },
  { q:"Kan jag kombinera distans och p√• plats?", a:"Ja, om uppdraget medger hybriduppl√§gg." },

  // GDPR
  { q:"F√∂ljer ni GDPR?", a:"Ja. Vi hanterar personuppgifter lagligt, s√§kert och med minimal insamling." },
  { q:"Hur raderar jag min data?", a:"Kontakta support eller beg√§r radering i kontoinst√§llningar ‚Äì vi hj√§lper dig direkt." },
  { q:"Hur hanterar ni journaluppgifter?", a:"Journaldata ska inte delas i chatten. Anv√§nd v√•rdgivarens s√§kra system f√∂r patientinformation." },

  // TEKNIK & SUPPORT
  { q:"F√•r ni driftst√∂rningar ibland?", a:"Som alla digitala tj√§nster kan det h√§nda. Vi √∂vervakar och kommunicerar l√§get i appen." },
  { q:"Hur kontaktar jag support?", a:"Skriv i chatten eller maila oss ‚Äì vi svarar snabbt vardagar och bevakar kritiska √§renden." },
  { q:"Hur rapporterar jag en bugg?", a:"Anv√§nd ‚ÄùRapportera problem‚Äù i appen och beskriv vad som h√§nde ‚Äì g√§rna med sk√§rmklipp." },

  // PRIS & OFFERT ‚Äì V√ÖRDGIVARE
  { q:"Kan vi f√• en snabb offert?", a:"Ja, ange kompetens, erfarenhetsniv√•, plats och tidsperiod ‚Äì vi √•terkommer samma dag." },
  { q:"Vad ing√•r i priset?", a:"Matchning, digital administration, tidrapportering och kvalitetskontroller. F√∂rs√§kring ligger hos v√•rdgivaren." },
  { q:"Kan ni bemanna med kort varsel?", a:"Vi g√∂r v√•rt b√§sta ‚Äì akuta f√∂rfr√•gningar prioriteras i n√§tverket." },

  // SKATT & MODELLER
  { q:"Vilken skattetabell anv√§nder ni i ber√§kningar?", a:"Som standard schablon, men du kan ange din kommun/tabell f√∂r mer exakt resultat." },
  { q:"Kan jag l√§gga till skattefria ers√§ttningar i kalkylen?", a:"Ja, l√§gg till traktamente/milers√§ttning s√• visas de separat utanf√∂r nettol√∂nen." },
  { q:"Visa mellanled i kalkylen?", a:"Sj√§lvklart ‚Äì efter avgift, bruttol√∂n, skatt, semester och netto. Allt syns √∂ppet." },
  { q:"Kan ni j√§mf√∂ra AB vs l√∂n via Curevia?", a:"Ja, vi visar en enkel j√§mf√∂relse och pekar p√• vad som skiljer i ansvar, skatt och administration." },

  // MATCHNING & KVALITET
  { q:"Hur s√§kerst√§ller ni kvalitet i matchningen?", a:"Profildata, verifierad legitimation och relevanta referenser. V√•rdgivare kan s√§tta krav och ge feedback." },
  { q:"Kan jag f√• uppdrag inom en specifik specialitet?", a:"Ja, filtrera p√• specialitet och l√§gg bevakning s√• pingar vi dig vid nya uppdrag." },
  { q:"Hur funkar feedback efter avslutat uppdrag?", a:"B√•da parter kan ge omd√∂me. Det f√∂rb√§ttrar matchningar fram√•t." },

  // AVSLUT & UPPF√ñLJNING
  { q:"Hur avslutar jag ett uppdrag?", a:"Rapportera sista passet och signera. Slutrapport och ers√§ttning hanteras direkt i systemet." },
  { q:"Kan jag f√• arbetsgivarintyg eller intyg p√• uppdrag?", a:"Ja, be support s√• hj√§lper vi dig med underlag." },
  { q:"Hur st√§nger vi ett uppdrag som v√•rdgivare?", a:"Bekr√§fta sista tidrapporten och signera digitalt. Fakturan skapas enligt avtal." },

  // KAMPANJER
  { q:"Har ni n√•gon v√§rvningsbonus?", a:"Ibland k√∂r vi kampanjer. Anv√§nd din inbjudningsl√§nk och se aktuella villkor i appen." },
  { q:"F√•r b√•de jag och den jag bjuder in bonus?", a:"Ja, n√§r kampanjvillkoren uppfylls ‚Äì till exempel efter f√∂rsta genomf√∂rda uppdrag." },

  // √ñVRIGT
  { q:"Vad kostar det att registrera sig?", a:"Det √§r gratis att skapa konto. Avgifter framg√•r f√∂rst n√§r du accepterar uppdrag." },
  { q:"Kan ni hj√§lpa till med vidareutbildning?", a:"Vi tipsar g√§rna om kurser och certifieringar ‚Äì fr√•ga efter f√∂rslag inom din specialitet." },
  { q:"Var kan jag f√∂lja er?", a:"F√∂lj oss p√• LinkedIn f√∂r nyheter, uppdrag och insikter." }
];

/* Nyckelknappar (pinned) */
const PinnedFAQs = [
  CureviaFAQs[0], CureviaFAQs[2], CureviaFAQs[11], CureviaFAQs[16], CureviaFAQs[22],
  CureviaFAQs[28], CureviaFAQs[40], CureviaFAQs[48], CureviaFAQs[58], CureviaFAQs[69]
];

/* =========================================================
   UI/DOM
========================================================= */
const log   = document.getElementById("log");
const inp   = document.getElementById("inp");
const btn   = document.getElementById("btn");
const dark  = document.getElementById("dark");
const toastEl = document.getElementById("toast");

const modalBg = document.getElementById("modalBg");
const cName   = document.getElementById("cName");
const cEmail  = document.getElementById("cEmail");
const cPhone  = document.getElementById("cPhone");
const cMsg    = document.getElementById("cMsg");
const cCancel = document.getElementById("cCancel");
const cSend   = document.getElementById("cSend");

let toastTimer=null;
function showToast(msg="Klart!", ms=2200){
  if (!toastEl) return;
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toastEl.classList.remove("show"), ms);
}
function addBubble(text, who="bot"){
  const div = document.createElement("div");
  div.className = "bubble " + (who==="me" ? "me" : "bot");
  if (text) div.innerText = text;
  log.appendChild(div);
  log.scrollTo({ top: log.scrollHeight, behavior: "smooth" });
  return div;
}
function addCopyIfLong(div){
  if (!div || !div.innerText) return;
  if (div.innerText.length <= 120) return;
  const cp = document.createElement("div");
  cp.className = "copy";
  cp.textContent = "üìã Kopiera";
  cp.onclick = () => navigator.clipboard.writeText(div.innerText);
  div.appendChild(cp);
}
function typingBubble(){ const b = addBubble("‚Ä¶","bot"); return { destroy(){ try{ b.remove(); }catch{} } }; }
function openNewTab(url, toastMsg){
  try { window.open(url, "_blank", "noopener,noreferrer"); if (toastMsg) showToast(toastMsg); } catch {}
}
function firstUrlIn(text){ const m = String(text||"").match(/https?:\/\/[^\s)]+/i); return m ? m[0] : null; }

/* ===== Chips ===== */
let chipsBar = null;
function clearChips(){ if(chipsBar){ try{ chipsBar.remove(); }catch{} chipsBar=null; } }
function createChip(it){
  const b = document.createElement("button");
  b.className = "chip";
  b.type = "button";
  b.setAttribute("aria-label", (it.text || it.label || "").trim());
  b.innerHTML = `<span class="emoji">${it.emoji || ""}</span><span class="label">${it.text || it.label || ""}</span>`;
  b.onclick = () => {
    if (it.url){ openNewTab(it.url, it.toast || "√ñppnade l√§nk i ny flik"); return; }
    const sendText = it.textSend || it.text || it.label;
    if (sendText){ send(sendText); }
  };
  return b;
}
function renderChips(items=[]){
  clearChips();
  if (!items || !items.length) return;
  chipsBar = document.createElement("div");
  chipsBar.className = "chips";
  for (const it of items){ chipsBar.appendChild(createChip(it)); }
  const last = [...log.querySelectorAll(".bubble.bot")].pop();
  if (last){ last.appendChild(chipsBar); }
  log.scrollTo({ top: log.scrollHeight, behavior:"smooth" });
}

/* ===== Dark mode ===== */
(function initTheme(){
  const saved = localStorage.getItem("curevia_dark");
  if (saved === "1" || (!saved && window.matchMedia?.("(prefers-color-scheme: dark)").matches)){
    document.body.classList.add("dark");
    dark.setAttribute("aria-pressed","true");
  }
})();
dark.onclick = () => {
  const on = document.body.classList.toggle("dark");
  dark.setAttribute("aria-pressed", on ? "true" : "false");
  localStorage.setItem("curevia_dark", on ? "1" : "0");
};

/* =========================================================
   BOOT
========================================================= */
boot();
async function boot(){
  try{
    // H√§mta meta om du vill ‚Äî men vi har egna fallback-suggestions h√§r
    await fetch(API, { headers: { "X-Session-Id": sessionId, "Accept-Language": navigator.language || "" }}).catch(()=>{});
    addBubble("Hej! üëã V√§lkommen till Curevia. Vad vill du g√∂ra?");
    renderChips([
      { emoji:"‚ÑπÔ∏è", text:"Om Curevia",        textSend:"Ber√§tta mer om Curevia" },
      { emoji:"üßÆ", text:"R√§kna ut nettol√∂n", textSend:"Ber√§kna nettol√∂n fr√•n faktura" },
      { emoji:"üá≥üá¥", text:"Jobba i Norge",     textSend:"Hur skaffar jag norsk legitimation (HPR)?" },
      { emoji:"üè•", text:"F√∂r v√•rdgivare",    textSend:"Vad erbjuder ni f√∂r v√•rdgivare?" },
      { emoji:"üë©‚Äç‚öïÔ∏è", text:"F√∂r v√•rdpersonal", textSend:"Vad erbjuder ni f√∂r v√•rdpersonal?" },
      { emoji:"üöÄ", text:"Registrera ‚Äì V√•rdpersonal", url:LINKS.regConsult, toast:"√ñppnade registreringen f√∂r v√•rdpersonal" },
      { emoji:"üß∑", text:"Registrera ‚Äì V√•rdgivare",   url:LINKS.regProvider, toast:"√ñppnade registreringen f√∂r v√•rdgivare" }
    ]);
  }catch{
    addBubble("Jag n√•dde inte servern just nu ‚Äì prova igen om en stund üôè");
  }
}

/* =========================================================
   SEND / ROUTING (FAQ ‚Üí kalkyl ‚Üí Norge ‚Üí GPT-fallback)
========================================================= */
let lastUserText = "";
btn.onclick = ()=> send(inp.value);
inp.addEventListener("input", () => { btn.disabled = !inp.value.trim(); });
inp.addEventListener("keydown", e => { if (e.key === "Enter"){ e.preventDefault(); if (inp.value.trim()) send(inp.value); }});

function normalize(s=""){ return s.toLowerCase().trim(); }
function faqFindExact(text){ return CureviaFAQs.find(f => normalize(f.q) === normalize(text)); }
function faqFindFuzzy(text){
  const t = normalize(text);
  return CureviaFAQs.find(f => normalize(f.q).includes(t) || normalize(f.a).includes(t));
}

async function send(text){
  if (!text || !text.trim()) return;
  clearChips();
  lastUserText = text;
  addBubble(text, "me");
  inp.value = "";
  btn.disabled = true;

  // Intent: snabbregistrering
  if (handleRegistrationIntent(text)) return;

  // Intent: kalkyl
  if (/(nett|ber[a√§]kna).*(faktur|l[√∂o]n)|fakturakalkyl/i.test(text)){
    return handleInvoiceCalc();
  }

  // Intent: Norge/HPR
  if (/norge|hpr|autorisa(s|z)jon|norsk legitimation/i.test(text)){
    return handleNorwayGuide();
  }

  // FAQ ‚Äì exact eller fuzzy
  const hit = faqFindExact(text) || faqFindFuzzy(text);
  if (hit){
    const b = addBubble(hit.a, "bot");
    addCopyIfLong(b);
    return smartSuggest(lastUserText, hit.a);
  }

  // Server/GPT-fallback med streaming
  return serverFallback(text);
}

/* =========================================================
   SERVER (GPT-5) FALLBACK ‚Äì SSE
========================================================= */
async function serverFallback(text){
  const bubble = addBubble("", "bot");
  const typing = typingBubble();
  let gotAny = false, finalText = "", finalSuggestions=[];
  try {
    const r = await fetch(API + "?stream=1", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "X-Session-Id": sessionId,
        "X-Lang": navigator.language || "",
        "Accept":"text/event-stream"
      },
      body: JSON.stringify({ message: text })
    });

    const ct = (r.headers.get("content-type") || "").toLowerCase();
    if (!ct.includes("text/event-stream")) {
      typing.destroy();
      const okJson = ct.includes("application/json");
      if (okJson){
        const data = await r.json();
        bubble.innerText = data.reply || "Tekniskt fel ‚Äì prova igen.";
        if (Array.isArray(data.suggestions)) finalSuggestions = data.suggestions;
      } else {
        bubble.innerText = "Tekniskt fel ‚Äì prova igen.";
      }
      addCopyIfLong(bubble);
      if (finalSuggestions?.length) renderChips(finalSuggestions);
      else smartSuggest(lastUserText, bubble.innerText);
      return;
    }

    const reader = r.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";
    while (true){
      const { value, done } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream:true });
      let idx;
      while ((idx = buffer.indexOf("\n\n")) >= 0) {
        const raw = buffer.slice(0, idx); buffer = buffer.slice(idx+2);
        const lines = raw.split(/\r?\n/);
        let event = "message", data="";
        for (const line of lines){
          if (!line) continue;
          if (line.startsWith("event:")) event = line.slice(6).trim();
          else if (line.startsWith("data:")) { let p=line.slice(5); if (p.startsWith(" ")) p=p.slice(1); data += p; }
        }
        if (!data) continue;

        if (event === "token"){
          if (!gotAny){ typing.destroy(); gotAny = true; }
          bubble.innerText += data; finalText += data;
          log.scrollTo({ top: log.scrollHeight });
          continue;
        }
        if (event === "final"){
          typing.destroy();
          try{
            const j = JSON.parse(data);
            if (!gotAny && j.reply){ bubble.innerText = j.reply; finalText=j.reply; }
            if (Array.isArray(j.suggestions)) finalSuggestions=j.suggestions;
          }catch{ if (!gotAny){ bubble.innerText = data; finalText=data; } }
          continue;
        }
      }
    }
    if (!gotAny && !bubble.innerText){ typing.destroy(); bubble.innerText="Inget svar ‚Äì prova igen."; }
    addCopyIfLong(bubble);
    if (finalSuggestions?.length) renderChips(finalSuggestions); else smartSuggest(lastUserText, bubble.innerText);
  } catch(e){
    typing.destroy();
    addBubble("Tekniskt fel ‚Äì prova igen.");
  }
}

/* =========================================================
   REGISTRERING ‚Äì intents
========================================================= */
function registrationMessage(){
  return "F√∂r att registrera dig, v√§nligen bes√∂k v√•r webbplats och f√∂lj registreringsanvisningarna. Om du beh√∂ver hj√§lp kan du alltid kontakta oss!";
}
function handleRegistrationIntent(userText=""){
  const t = (userText||"").toLowerCase();
  const isConsult = /(registrera|sign ?up|konto).*?(konsult|sjuksk√∂ters|l√§kar|nurse|doctor)/.test(t);
  const isProvider = /(registrera|sign ?up|konto).*?(v√•rdgivar|klinik|mottag|provider|clinic|hospital)/.test(t);
  const genericReg = /(registrera|sign ?up|skapa konto)/.test(t);

  if (isConsult){ openNewTab(LINKS.regConsult, "√ñppnade registreringen f√∂r v√•rdpersonal"); addBubble(registrationMessage(), "bot"); return true; }
  if (isProvider){ openNewTab(LINKS.regProvider, "√ñppnade registreringen f√∂r v√•rdgivare"); addBubble(registrationMessage(), "bot"); return true; }
  if (genericReg){
    renderChips([
      { emoji:"üöÄ", text:"Registrera ‚Äì V√•rdpersonal", url:LINKS.regConsult, toast:"√ñppnade registreringen f√∂r v√•rdpersonal" },
      { emoji:"üè•", text:"Registrera ‚Äì V√•rdgivare",   url:LINKS.regProvider, toast:"√ñppnade registreringen f√∂r v√•rdgivare" }
    ]);
    addBubble(registrationMessage(), "bot"); return true;
  }
  return false;
}

/* =========================================================
   NETTOL√ñNEKALKYLATOR (fakturabelopp exkl moms)
========================================================= */
function round(n){ return Math.round(Number(n)||0); }
function pct(n){ return (Number(n)||0).toFixed(4); }

function calcNetFromInvoice({ amountExVat, platformFeePct, agPct, taxPct, vacationPct, taxFreeSEK=0 }){
  const efterAvgift = amountExVat * (1 - platformFeePct);
  const brutto = efterAvgift / (1 + agPct);
  const bruttoMedSem = brutto * (1 + vacationPct);
  const prelimSkatt = bruttoMedSem * taxPct;
  const netto = bruttoMedSem - prelimSkatt;
  const totalUt = netto + taxFreeSEK;
  return {
    efterAvgift: round(efterAvgift),
    bruttol√∂n: round(brutto),
    bruttol√∂nMedSemester: round(bruttoMedSem),
    prelimin√§rSkatt: round(prelimSkatt),
    nettol√∂n: round(netto),
    skattefriaErsSEK: round(taxFreeSEK),
    nettoutbetalningTotalt: round(totalUt)
  };
}

function handleInvoiceCalc(){
  const beloppStr = prompt("Fakturabelopp exkl. moms (SEK)?", "100000");
  const belopp = Number(beloppStr||"");
  if (!belopp || belopp <= 0){ addBubble("Okej! S√§g till det exakta beloppet s√• r√§knar jag.", "bot"); return; }

  // Parametrar (kan g√∂ras justerbara vid behov)
  const platformFeePct = DEFAULTS.platformFeePct;
  const agPct = DEFAULTS.agPct;
  const taxPct = DEFAULTS.taxPct;
  const vacationPct = DEFAULTS.vacationPct;
  const taxFreeSEK = 0;

  const r = calcNetFromInvoice({ amountExVat: belopp, platformFeePct, agPct, taxPct, vacationPct, taxFreeSEK });
  const out =
`H√§r √§r din uppskattning:
‚Ä¢ Efter avgift (${(platformFeePct*100).toFixed(1)}%): ${r.efterAvgift.toLocaleString()} kr
‚Ä¢ Bruttol√∂n: ${r.bruttol√∂n.toLocaleString()} kr
‚Ä¢ Bruttol√∂n inkl. semester (${(vacationPct*100).toFixed(0)}%): ${r.bruttol√∂nMedSemester.toLocaleString()} kr
‚Ä¢ Prelimin√§r skatt (${(taxPct*100).toFixed(0)}%): ‚àí${r.prelimin√§rSkatt.toLocaleString()} kr
‚Ä¢ Nettol√∂n: ${r.nettol√∂n.toLocaleString()} kr
‚Ä¢ Skattefria ers√§ttningar: +${r.skattefriaErsSEK.toLocaleString()} kr
= Utbetalning totalt: ${r.nettoutbetalningTotalt.toLocaleString()} kr

Vill du finjustera med din skattetabell eller j√§mf√∂ra mot fakturering via eget AB?`;
  const b = addBubble(out, "bot"); addCopyIfLong(b);
  renderChips([
    { emoji:"üßÆ", text:"R√§kna igen med annat belopp", textSend:"Ber√§kna nettol√∂n fr√•n faktura" },
    { emoji:"üìé", text:"L√§gg till traktamente/mil", textSend:"L√§gg till skattefria ers√§ttningar i kalkylen" }
  ]);
}

/* =========================================================
   NORGE ‚Äì AUTORISASJON (HPR) GUIDE
========================================================= */
function handleNorwayGuide(){
  const guide =
`S√• skaffar du norsk legitimation (HPR) ‚Äì steg f√∂r steg:

1) F√∂rbered dokument
   ‚Ä¢ Pass/id, examensbevis, svensk legitimation, CV.
   ‚Ä¢ Certificate of Current Professional Status/‚ÄùLetter of Good Standing‚Äù.
   ‚Ä¢ Auktoriserade √∂vers√§ttningar om dokument ej p√• norska/svenska/engelska.

2) Ans√∂k om autorisasjon
   ‚Ä¢ Ans√∂kan g√∂rs digitalt via Helsedirektoratet (HPR).
   ‚Ä¢ Skapa konto, ladda upp dokument, betala avgift.
   ‚Ä¢ Handl√§ggningstid varierar ‚Äì r√§kna med n√•gra veckor.

3) Efter beslut ‚Äì HPR-nummer
   ‚Ä¢ Vid beviljad autorisasjon registreras du i HPR (Norges legitimation).
   ‚Ä¢ Du f√•r HPR-nummer som arbetsgivare/v√•rdgivare kontrollerar.

4) Praktiska steg f√∂r arbete i Norge
   ‚Ä¢ D-nummer (tillf√§lligt personnummer) via Skatteetaten.
   ‚Ä¢ Skattekort (tax card) ‚Äì kr√§vs f√∂r l√∂n.
   ‚Ä¢ Norsk bank/utbetalning enligt arbetsgivarens rutiner.
   ‚Ä¢ Eventuellt HMS-kort och lokala intro-/IT-beh√∂righeter.

Tips:
‚Ä¢ Spara alla original och ha skannade PDF:er redo (h√∂g kvalitet).
‚Ä¢ Kolla krav per yrkeskategori ‚Äì vissa specialiteter kr√§ver extra intyg.
‚Ä¢ Beh√∂ver du intyg fr√•n Sverige (good standing)? Best√§ll i god tid.

Vill du att jag g√∂r en checklista anpassad f√∂r din yrkesroll och situation?`;
  const b = addBubble(guide, "bot"); addCopyIfLong(b);
  renderChips([
    { emoji:"‚úÖ", text:"Skapa personlig checklista", textSend:"Skapa norsk legitimation-checklista √•t mig" },
    { emoji:"üìé", text:"Vilka intyg saknar jag?", textSend:"Hj√§lp mig lista intyg och √∂vers√§ttningar" }
  ]);
}

/* =========================================================
   SMART SUGGESTIONS (fallback)
========================================================= */
function smartSuggest(userText="", botText=""){
  const t = (userText||"").toLowerCase();
  const isProv = /(v√•rdgivar|klinik|mottag|provider|clinic|hospital)/.test(t);
  const isCons = /(konsult|sjuksk√∂ters|l√§kar|nurse|doctor)/.test(t);

  if (isProv) return renderChips([
    { emoji:"üëÄ", text:"Se hur det funkar", textSend:"Hur funkar Curevia f√∂r v√•rdgivare?" },
    { emoji:"üìÑ", text:"Pris & paket",      textSend:"Vad kostar det?" },
    { emoji:"üìÖ", text:"Boka demo",         url:LINKS.demo, toast:"√ñppnade demo-bokning i ny flik" },
    { emoji:"üè•", text:"Registrera ‚Äì V√•rdgivare", url:LINKS.regProvider, toast:"√ñppnade registreringen f√∂r v√•rdgivare" }
  ]);
  if (isCons) return renderChips([
    { emoji:"üßÆ", text:"R√§kna ut nettol√∂n", textSend:"Ber√§kna nettol√∂n fr√•n faktura" },
    { emoji:"üá≥üá¥", text:"Jobba i Norge",     textSend:"Hur skaffar jag norsk legitimation (HPR)?" },
    { emoji:"üöÄ", text:"Registrera ‚Äì V√•rdpersonal", url:LINKS.regConsult, toast:"√ñppnade registreringen f√∂r v√•rdpersonal" }
  ]);
  return renderChips([
    { emoji:"‚ÑπÔ∏è", text:"Om Curevia",        textSend:"Ber√§tta mer om Curevia" },
    { emoji:"üßÆ", text:"R√§kna ut nettol√∂n", textSend:"Ber√§kna nettol√∂n fr√•n faktura" },
    { emoji:"üá≥üá¥", text:"Jobba i Norge",     textSend:"Hur skaffar jag norsk legitimation (HPR)?" }
  ]);
}

/* =========================================================
   CONTACT FORM
========================================================= */
function openContactForm(){ modalBg.style.display = "flex"; cName.focus(); }
function closeContactForm(){ modalBg.style.display = "none"; }
cCancel.onclick = closeContactForm;
cSend.onclick = async () => {
  const name  = cName.value.trim();
  const email = cEmail.value.trim();
  const phone = cPhone.value.trim();
  const msg   = cMsg.value.trim();
  if (!name || !email){ alert("Ange namn och e-post."); return; }
  try{
    const r = await fetch(API, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "X-Session-Id": sessionId },
      body: JSON.stringify({ contact:{ name, email, phone, message: msg } })
    });
    const ok = r.ok;
    closeContactForm();
    addBubble(ok ? "Tack! Vi h√∂r av oss inom kort. üíô" : "Kunde inte skicka just nu ‚Äì prova igen.");
  }catch{
    closeContactForm();
    addBubble("Kunde inte skicka just nu ‚Äì prova igen.");
  }
};

/* =========================================================
   FINAL: be om filer/underlag f√∂r att g√∂ra boten komplett
========================================================= */
setTimeout(() => {
  const need =
`F√∂r att g√∂ra boten komplett ‚Äì kan du dela f√∂ljande filer/underlag?
‚Ä¢ Exakt plattformsavgift (%), ev. niv√•er per kompetens.
‚Ä¢ Policy/avtalstexter (PDF/URL) f√∂r: ers√§ttningar, OB, semester, sjukl√∂n.
‚Ä¢ Textmallar f√∂r: registrering, dataskydd/GDPR, support.
‚Ä¢ Lista √∂ver kompetenser/specialiteter ni erbjuder (CSV/JSON).
‚Ä¢ Eventuella skattetabeller/schabloner per kommun (om ni vill vara exakta).
‚Ä¢ Processbeskrivning (PDF/URL) om hur ni vill att norsk autorisasjon ska presenteras.
‚Ä¢ Logotyper/brand (SVG/PNG) + tonalitetsguide.

L√§gg dem i repo (/public/content) eller ge mig l√§nkar, s√• kopplar jag in dem.`;
  const b = addBubble(need, "bot"); addCopyIfLong(b);
}, 8000);
</script>
</body>
</html>
