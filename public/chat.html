<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curevia – Chat</title>
  <style>
    :root{
      --bg:#f8fafc; --bot:#eef2ff; --me:#2563eb; --text:#0f172a;
      --border:#cbd5e1;
    }
    body{font-family:system-ui,Arial;background:var(--bg);color:var(--text);margin:0}
    .wrap{max-width:720px;margin:0 auto;padding:24px}
    h3{margin:0 0 12px;display:flex;align-items:center;justify-content:space-between}
    .bubble{padding:12px 14px;border-radius:16px;margin:8px 0;max-width:80%;white-space:pre-wrap}
    .bot{background:var(--bot);border-top-left-radius:6px}
    .me{background:var(--me);color:#fff;margin-left:auto;border-top-right-radius:6px}
    .row{display:flex;gap:8px;position:sticky;bottom:0;background:var(--bg);padding:8px 0}
    input{flex:1;padding:12px;border:1px solid var(--border);border-radius:12px}
    button{padding:12px 16px;border:0;border-radius:12px;background:#111827;color:#fff;cursor:pointer}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{background:#e2e8f0;border-radius:999px;padding:6px 10px;font-size:14px;cursor:pointer}
    .copy{font-size:12px;color:#64748b;margin-top:4px;cursor:pointer}
    .toggle{border:1px solid var(--border);background:#fff;color:#111827;border-radius:999px;padding:6px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h3>
      <span>Curevia Assistant</span>
      <button id="dark" class="toggle" type="button">Mörkt läge</button>
    </h3>

    <div id="log"></div>
    <div id="chips" class="chips"></div>

    <div class="row">
      <input id="inp" placeholder="Skriv ett meddelande..." />
      <button id="btn" type="button">Skicka</button>
    </div>
  </div>

<script>
/* ===== Config ===== */
const API = "/api/curevia-chat";  // <— rätt, utan .js
const sessionId = self.crypto?.randomUUID?.() || ("sess-" + Date.now());

/* ===== DOM ===== */
const log   = document.getElementById("log");
const chips = document.getElementById("chips");
const inp   = document.getElementById("inp");
const btn   = document.getElementById("btn");
const dark  = document.getElementById("dark");

/* ===== UI helpers ===== */
function addBubble(text, who="bot"){
  const div = document.createElement("div");
  div.className = "bubble " + (who==="me" ? "me" : "bot");
  div.innerText = text || "";
  if (who !== "me" && (text||"").length > 120){
    const cp = document.createElement("div");
    cp.className = "copy";
    cp.textContent = "📋 Kopiera";
    cp.onclick = () => navigator.clipboard.writeText(div.innerText);
    div.appendChild(cp);
  }
  log.appendChild(div);
  log.scrollTo({ top: log.scrollHeight, behavior: "smooth" });
  return div;
}

function typingBubble() {
  const b = addBubble("…", "bot");
  return { destroy(){ try{ b.remove(); }catch{} } };
}

/* ===== Dark mode ===== */
dark.onclick = () => document.body.classList.toggle("dark");

/* ===== Boot ===== */
boot();
async function boot(){
  try{
    const r = await fetch(API, { headers: { "X-Session-Id": sessionId }});
    const ct = (r.headers.get("content-type")||"").toLowerCase();
    if (!ct.includes("application/json")) throw new Error("meta not json");
    const m = await r.json();
    addBubble("Hej! 👋 Hur kan jag hjälpa till idag?");
    (m.suggested || []).forEach(x=>{
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = x.label;
      chip.onclick = ()=> send(x.label);
      chips.appendChild(chip);
    });
  }catch{
    addBubble("Jag nådde inte servern just nu – prova igen om en stund 🙏");
  }
}

/* ===== Send ===== */
btn.onclick = ()=> send(inp.value);
inp.addEventListener("keydown", e => { if (e.key==="Enter") send(inp.value); });

async function send(text){
  if (!text || !text.trim()) return;
  addBubble(text, "me");
  inp.value = "";

  const bubble = addBubble("", "bot");          // där svaret hamnar
  const typing = typingBubble();                // liten “…”-indikator
  let gotAnyToken = false;

  try {
    const r = await fetch(API + "?stream=1", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "X-Session-Id": sessionId,
        "Accept":"text/event-stream"
      },
      body: JSON.stringify({ message: text })
    });

    const ct = (r.headers.get("content-type") || "").toLowerCase();

    // Skydd: om vi råkar få HTML/JS/text, visa fel (inte källkod i bubblan)
    if (!ct.includes("text/event-stream")) {
      const safe = ct.includes("application/json");
      if (safe) {
        const data = await r.json();
        typing.destroy();
        bubble.innerText = data.reply || "Tekniskt fel – prova igen.";
      } else {
        typing.destroy();
        bubble.innerText = "Tekniskt fel – prova igen.";
      }
      return;
    }

    // === Robust SSE-parser: funkar med BÅDE din backend (event: token/final)
    // === OCH OpenAI-råstream (data: {...delta.content...})
    const reader = r.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";

    while (true){
      const { value, done } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream:true });

      // Processa hela SSE-eventblock (separerade med tom rad)
      let idx;
      while ((idx = buffer.indexOf("\n\n")) >= 0) {
        const raw = buffer.slice(0, idx);
        buffer = buffer.slice(idx + 2);

        const lines = raw.split(/\r?\n/);
        let event = "message";
        let data  = "";

        for (const line of lines){
          if (!line) continue;
          if (line.startsWith("event:")) event = line.slice(6).trim();
          else if (line.startsWith("data:")) {
            let payload = line.slice(5);
            if (payload.startsWith(" ")) payload = payload.slice(1); // ta bort bara ett space efter kolon
            data += payload;
          }
        }
        if (!data) continue;

        // 1) Din backend: event: token → data = sträng
        if (event === "token") {
          if (!gotAnyToken) { typing.destroy(); gotAnyToken = true; }
          bubble.innerText += data;                 // bevara mellanslag/rader
          log.scrollTo({ top: log.scrollHeight });
          continue;
        }

        // 2) Din backend: event: final → data kan vara sträng eller {"reply": "..."}
        if (event === "final") {
          typing.destroy();
          try {
            const j = JSON.parse(data);
            if (!gotAnyToken && j.reply) bubble.innerText = j.reply;
            // (ev. citations mm kan hanteras här om du börjar skicka dem)
          } catch {
            if (!gotAnyToken) bubble.innerText = data;
          }
          continue;
        }

        // 3) OpenAI råstream (inga event-fält, bara data: {choices[0].delta.content})
        //    eller event: message med samma data
        try{
          const j = JSON.parse(data);
          const delta = j?.choices?.[0]?.delta?.content;
          if (delta){
            if (!gotAnyToken) { typing.destroy(); gotAnyToken = true; }
            bubble.innerText += delta;
          }
        }catch{/* om inte JSON, ignorerar vi */}
      }
    }

    if (!gotAnyToken) { typing.destroy(); if (!bubble.innerText) bubble.innerText = "Inget svar – prova igen."; }

    // Lägg copy efteråt om svaret är längre
    if (bubble.innerText.length > 120){
      const cp = document.createElement("div");
      cp.className = "copy";
      cp.textContent = "📋 Kopiera";
      cp.onclick = () => navigator.clipboard.writeText(bubble.innerText);
      bubble.appendChild(cp);
    }

  } catch(e) {
    typing.destroy();
    bubble.innerText = "Tekniskt fel – prova igen.";
  }
}
</script>
</body>
</html>
