(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const S="/api/curevia-chat";var B,Q;const I=((Q=(B=self.crypto)==null?void 0:B.randomUUID)==null?void 0:Q.call(B))||"sess-"+Date.now();function r(e,t={},...o){const a=document.createElement(e);for(const[n,s]of Object.entries(t||{}))n==="class"?a.className=s:n==="html"?a.innerHTML=s:a.setAttribute(n,s);for(const n of o)n&&a.appendChild(typeof n=="string"?document.createTextNode(n):n);return a}const x={};function d(){return localStorage.getItem("lang")||(navigator.language||"sv").slice(0,2)}async function R(){const e=d();if(x[e])return x[e];try{const t=await fetch(`/locales/${e}/common.json`);x[e]=await t.json()}catch{x[e]={greet:"Hej! üëã V√§lkommen till Curevia. Vad vill du g√∂ra?",send:"Skicka",placeholder:"Skriv ett meddelande...",darkToggle:"M√∂rkt l√§ge",netTitle:"Snabb kalkyl ‚Äì Nettol√∂n",netLabel:"Fakturerat belopp (exkl. moms):",netOutPrefix:"‚âà Nettol√∂n:"}}return x[e]}function k(e){const t=d(),a=(x[t]||{})[e];return typeof a=="function"?a():a||e}const U=document.getElementById("app"),V=r("div",{class:"wrap",role:"main"}),$=r("h3",{role:"heading","aria-level":"1"},r("span",{id:"title"},"Curevia Assistant"),r("div",{style:"display:flex; gap:8px; align-items:center"},(()=>{const e=r("select",{id:"lang",class:"toggle","aria-label":"Language selector"});return e.innerHTML='<option value="sv">Svenska</option><option value="en">English</option><option value="no">Norsk</option><option value="da">Dansk</option>',e})(),r("button",{id:"dark",class:"toggle",type:"button","aria-pressed":"false","aria-label":"V√§xla m√∂rkt l√§ge"},"M√∂rkt l√§ge"))),g=r("div",{id:"log","aria-live":"polite","aria-atomic":"false"}),G=r("div",{class:"row",role:"form","aria-label":"Chat input"},r("input",{id:"inp",type:"text",placeholder:"Skriv ett meddelande...",autocomplete:"off","aria-label":"Skriv ett meddelande"}),r("button",{id:"btn",class:"primary",type:"button"},"Skicka"));V.append($,g,G);U.appendChild(V);const z=r("div",{id:"netcard",class:"bubble bot","aria-live":"polite"},r("div",{id:"netTitle",style:"font-weight:700; margin-bottom:6px"},"Snabb kalkyl ‚Äì Nettol√∂n"),r("label",{for:"netInput",id:"netLabel"},"Fakturerat belopp (exkl. moms):"),r("input",{id:"netInput",type:"text",inputmode:"decimal",style:"margin:6px 0; width:100%; padding:10px; border:1px solid var(--border); border-radius:10px",placeholder:"t.ex. 120 000"}),r("div",{id:"netOut",style:"margin-top:4px"})),Y=r("div",{class:"bubble bot",style:"font-size:13px"},r("span",{id:"privacy",html:'Vi anonymiserar fr√•gor och sparar inga personuppgifter. <a href="#" target="_blank" rel="noopener">L√§s mer</a>.'}));function w(e,t="bot"){const o=r("div",{class:"bubble "+(t==="me"?"me":"bot")});return e&&(o.innerText=e),g.appendChild(o),g.scrollTop=g.scrollHeight,o}function _(e){if(!e||!e.innerText||e.innerText.length<=120)return;const t=r("div",{class:"copy"},"üìã Kopiera");t.onclick=()=>navigator.clipboard.writeText(e.innerText),e.appendChild(t)}function Z(){const e=w("‚Ä¶","bot");return{destroy(){try{e.remove()}catch{}}}}function D(e){const t=r("div",{class:"modalOverlay",role:"dialog","aria-modal":"true"}),o=r("div",{class:"modal"}),a=r("h4",{},"L√§mna dina uppgifter"),n=r("form",{id:"contactForm"}),s=r("input",{type:"text",name:"name",placeholder:"Namn",required:"true","aria-label":"Namn"}),i=r("input",{type:"email",name:"email",placeholder:"E-post",required:"true","aria-label":"E-post"}),u=r("input",{type:"tel",name:"phone",placeholder:"Telefon (valfritt)","aria-label":"Telefon (valfritt)"}),b=r("textarea",{name:"message",placeholder:"Meddelande (valfritt)",rows:"3","aria-label":"Meddelande (valfritt)"}),E=r("input",{type:"hidden",name:"category",value:e==="improvements"||e==="invoice"?e:"general"}),N=r("div",{class:"actions"}),O=r("button",{type:"button"},"Avbryt"),p=r("button",{class:"primary",type:"submit"},"Skicka");N.append(O,p),n.append(s,i,u,b,E,N),o.append(a,n),t.appendChild(o),document.body.appendChild(t);const m=()=>{try{t.remove()}catch{}};O.onclick=m,t.addEventListener("click",h=>{h.target===t&&m()}),document.addEventListener("keydown",function h(v){v.key==="Escape"&&(m(),document.removeEventListener("keydown",h))}),n.onsubmit=async h=>{h.preventDefault(),p.disabled=!0;try{const v={contact:{name:s.value.trim(),email:i.value.trim(),phone:u.value.trim(),message:b.value.trim(),category:E.value}},c=await fetch(S,{method:"POST",headers:{"Content-Type":"application/json","X-Session-Id":I},body:JSON.stringify(v)});if(c.ok)m(),w("Tack! Vi h√∂r av oss inom kort.","bot");else{const f=await c.text().catch(()=>"");w("Kunde inte skicka just nu. F√∂rs√∂k igen senare.","bot"),console.warn("contact error",f)}}catch{w("Kunde inte skicka just nu. F√∂rs√∂k igen senare.","bot")}finally{p.disabled=!1}}}function M(e,t){if(!e||!e.data||e.data.action!=="open_url"||!e.data.url)return!1;const o=String(e.data.intent||"");if(!(o==="demo"||o.startsWith("register")))return!1;const n=(t||"").toLowerCase(),s=/(demo|visa plattformen|genomg√•ng|boka.*m√∂te|book.*demo)/.test(n),i=/(registrera|signa|skapa konto|sign ?up)/.test(n);return s||i}let C=null;function X(){if(C){try{C.remove()}catch{}C=null}}function ee(e){const t=r("button",{class:"chip",type:"button","aria-label":(e.text||e.label||"").trim()},r("span",{class:"emoji"},e.emoji||""),r("span",{class:"label"},e.text||e.label||""));return t.onclick=()=>{if(e.url){window.open(e.url,"_blank","noopener,noreferrer");return}const o=e.textSend||e.text||e.label;o&&P(o)},t}function A(e=[]){if(X(),!e||!e.length)return;C=r("div",{class:"chips"});for(const o of e)C.appendChild(ee(o));const t=[...g.querySelectorAll(".bubble.bot")].pop();t&&t.appendChild(C),g.scrollTop=g.scrollHeight}(function(){var o;const t=localStorage.getItem("curevia_dark");(t==="1"||!t&&((o=window.matchMedia)!=null&&o.call(window,"(prefers-color-scheme: dark)").matches))&&(document.body.classList.add("dark"),document.getElementById("dark").setAttribute("aria-pressed","true"))})();document.getElementById("dark").onclick=()=>{const e=document.body.classList.toggle("dark");document.getElementById("dark").setAttribute("aria-pressed",e?"true":"false"),localStorage.setItem("curevia_dark",e?"1":"0")};const q=document.getElementById("lang");q.value=["sv","en","no","da"].includes(d())?d():"sv";q.onchange=()=>{localStorage.setItem("lang",q.value),J()};function te(e,t){const o={sv:["sv-SE","SEK"],en:["en-GB","SEK"],no:["nb-NO","NOK"],da:["da-DK","DKK"]}[t]||["sv-SE","SEK"];return new Intl.NumberFormat(o[0],{style:"currency",currency:o[1],maximumFractionDigits:0}).format(e)}function ne(){const e=d();return{sv:.55,en:.55,no:.57,da:.56}[e]||.55}function oe(e){if(e=String(e).trim(),!e)return NaN;const t=e.replace(/[^0-9,\.\s]/g,"").replace(/\s+/g,""),o=t.lastIndexOf(","),a=t.lastIndexOf(".");let n=t;o>a?n=t.replace(/\./g,"").replace(",","."):n=t.replace(/,/g,"");const s=Number(n);return Number.isFinite(s)?s:NaN}function H(){var s;const e=d(),t=oe(document.getElementById("netInput").value),o=document.getElementById("netOut");if(!isFinite(t)||t<=0){o.textContent="";return}const a=t*ne(),n=((s=x[e])==null?void 0:s.netOutPrefix)||"‚âà";o.textContent=`${n} ${te(a,e)}`}function J(){const e=d(),t=document.getElementById("dark"),o=document.getElementById("inp"),a=document.getElementById("btn");document.documentElement.lang=e,t.textContent=k("darkToggle")||t.textContent,t.setAttribute("aria-label",k("darkToggleAria")||""),a.textContent=k("send")||a.textContent,o.placeholder=k("placeholder")||o.placeholder,document.getElementById("netTitle").textContent=k("netTitle")||"Snabb kalkyl ‚Äì Nettol√∂n",document.getElementById("netLabel").textContent=k("netLabel")||"Fakturerat belopp (exkl. moms):",H()}(async function(){await R(),w(k("greet")||"Hej! üëã V√§lkommen till Curevia. Vad vill du g√∂ra?"),g.appendChild(z),g.appendChild(Y);const t=document.getElementById("inp");try{t.focus()}catch{}J();try{const o=new AbortController,a=setTimeout(()=>o.abort(),4e3),n=await fetch(S,{headers:{"X-Session-Id":I,"Accept-Language":d()},signal:o.signal});if(clearTimeout(a),(n.headers.get("content-type")||"").toLowerCase().includes("application/json")){const i=await n.json();Array.isArray(i.suggestedQuestions)&&i.suggestedQuestions.length?A(i.suggestedQuestions.map(u=>({emoji:"üí°",text:u}))):Array.isArray(i.topFaqs)&&i.topFaqs.length?A(i.topFaqs.map(u=>({emoji:"üí°",text:u.q}))):Array.isArray(i.suggested)&&i.suggested.length&&A(i.suggested)}}catch{}window.CureviaChat={getSuggested:async function(){const a=await(await fetch(S,{headers:{"X-Session-Id":I,"Accept-Language":d()}})).json().catch(()=>({}));return{suggestedQuestions:Array.isArray(a.suggestedQuestions)?a.suggestedQuestions:Array.isArray(a.suggested)?a.suggested.map(n=>n.text||n.label||"").filter(Boolean):[]}},ask:async function(o){const n=await(await fetch(S,{method:"POST",headers:{"Content-Type":"application/json","X-Session-Id":I},body:JSON.stringify({message:o})})).json().catch(()=>({reply:"Tekniskt fel ‚Äì prova igen."}));return{reply:n.reply,suggestedQuestions:Array.isArray(n.suggestedQuestions)?n.suggestedQuestions:Array.isArray(n.suggestions)?n.suggestions.map(s=>s.text||s.label||"").filter(Boolean):[],data:n.data&&typeof n.data=="object"?n.data:n.action||n.url?{action:n.action||null,url:n.url||null}:null}}}})();const L=document.getElementById("inp"),ae=document.getElementById("btn");ae.onclick=()=>P(L.value);L.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),L.value.trim()&&P(L.value))});document.getElementById("netInput").addEventListener("input",H);async function P(e){var n,s,i,u;if(!e||!e.trim())return;X(),w(e,"me"),L.value="";const t=w("","bot"),o=Z();let a=null;try{const b=await fetch(S+"?stream=1",{method:"POST",headers:{"Content-Type":"application/json","X-Session-Id":I,"X-Lang":d(),Accept:"text/event-stream"},body:JSON.stringify({message:e})}),E=(b.headers.get("content-type")||"").toLowerCase();if(!E.includes("text/event-stream")){if(o.destroy(),E.includes("application/json")){const c=await b.json();if(t.innerText=c.reply||"Tekniskt fel ‚Äì prova igen.",a=c.faqId||null,M(c,e))try{window.open(c.data.url,"_blank","noopener,noreferrer")}catch{}if(((n=c==null?void 0:c.data)==null?void 0:n.action)==="open_contact_form"){const f=String(((s=c==null?void 0:c.data)==null?void 0:s.intent)||"");D(f==="improvements"||f==="invoice"?f:"general")}Array.isArray(c.suggestions)&&A(c.suggestions)}else t.innerText="Tekniskt fel ‚Äì prova igen.";_(t),F(t,a);return}const N=b.body.getReader(),O=new TextDecoder("utf-8");let p="",m=!1,h="";for(;;){const{value:v,done:c}=await N.read();if(c)break;p+=O.decode(v,{stream:!0});let f;for(;(f=p.indexOf(`

`))>=0;){const K=p.slice(0,f);p=p.slice(f+2);const W=K.split(/\r?\n/);let j="message",T="";for(const l of W)if(l){if(l.startsWith("event:"))j=l.slice(6).trim();else if(l.startsWith("data:")){let y=l.slice(5);y.startsWith(" ")&&(y=y.slice(1)),T+=y}}if(T&&(j==="token"&&(m||(o.destroy(),m=!0),t.innerText+=T,h+=T),j==="final")){o.destroy();try{const l=JSON.parse(T);if(!m&&l.reply&&(t.innerText=l.reply),a=l.faqId||null,M(l,e))try{window.open(l.data.url,"_blank","noopener,noreferrer")}catch{}if(((i=l==null?void 0:l.data)==null?void 0:i.action)==="open_contact_form"){const y=String(((u=l==null?void 0:l.data)==null?void 0:u.intent)||"");D(y==="improvements"||y==="invoice"?y:"general")}Array.isArray(l.suggestions)&&A(l.suggestions)}catch{m||(t.innerText=T)}}}}t.innerText||(o.destroy(),t.innerText="Inget svar ‚Äì prova igen."),_(t),F(t,a)}catch{o.destroy(),t.innerText="Tekniskt fel ‚Äì prova igen.",F(t,a)}}function F(e,t){const o=r("div",{class:"feedback"},r("button",{class:"thumb",type:"button","aria-label":"Tummen upp"},"üëç"),r("button",{class:"thumb",type:"button","aria-label":"Tummen ner"},"üëé")),[a,n]=o.querySelectorAll("button"),s=async i=>{try{await fetch(S,{method:"POST",headers:{"Content-Type":"application/json","X-Session-Id":I},body:JSON.stringify({feedback:{faqId:t,up:i}})})}catch{}o.remove()};a.onclick=()=>s(!0),n.onclick=()=>s(!1),e.appendChild(o)}
